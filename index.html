<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GemArticle - AI Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* å­—é«”èˆ‡åŸºç¤è¨­å®š */
    .font-eng { font-family: 'Merriweather', serif; }
    .font-chn { font-family: 'Noto Sans TC', sans-serif; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    
    /* 3D å¡ç‰‡ç¿»è½‰ */
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    .group.flipped .content-box { transform: rotateY(180deg); }

    /* å‹•ç•« */
    .listening-pulse { animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }

    /* ğŸ”¥ äº’å‹•æ–‡å­—æ¨£å¼ ğŸ”¥ */
    .clickable-word {
        cursor: pointer;
        padding: 2px 0;
        border-radius: 4px;
        transition: background-color 0.2s, color 0.2s;
    }
    .clickable-word:hover {
        background-color: #e0e7ff; /* Indigo-100 */
        color: #4338ca; /* Indigo-700 */
        text-decoration: underline;
    }
    
    /* ğŸ”¥ ç¿»è­¯å½ˆçª—æ¨£å¼ ğŸ”¥ */
    #word-popup {
        position: absolute;
        z-index: 50;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        padding: 12px;
        min-width: 200px;
        max-width: 280px;
        display: none; /* é è¨­éš±è— */
        animation: popup-fade 0.2s ease-out;
    }
    @keyframes popup-fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #word-popup::after { /* å°ç®­é ­ */
        content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%) rotate(45deg);
        width: 12px; height: 12px; background: white; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center font-sans">

  <div id="view-input" class="w-full max-w-lg p-6 transition-all duration-300">
    <div class="bg-white rounded-2xl shadow-xl p-8 relative">
      <button onclick="openWordBank()" class="absolute top-4 right-4 text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition" title="My Word Bank">
        <span class="text-xl">ğŸ“š</span>
      </button>

      <div class="flex justify-center mb-6 border-b border-gray-200">
        <button onclick="switchTab('topic')" id="tab-topic" class="border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2">âœ¨ AI ç”Ÿæˆ</button>
        <button onclick="switchTab('paste')" id="tab-paste" class="text-gray-500 px-6 py-2">ğŸ“‹ è²¼ä¸Šæ–‡ç« </button>
      </div>

      <div class="mb-6 bg-gray-50 p-3 rounded-xl border border-gray-200">
         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ğŸ—£ï¸ Voice</label>
         <select id="input-voice" class="w-full bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm outline-none"></select>
      </div>

      <div id="form-topic" class="block">
        <input type="text" id="input-topic" class="w-full mb-4 px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Topic (e.g., Travel, AI...)">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <select id="input-scenario" class="px-3 py-3 border rounded-xl bg-white text-sm text-indigo-700 font-semibold">
            <option value="article">ğŸ“˜ Article</option>
            <option value="conversation">ğŸ’¬ Dialogue</option>
            <option value="news">ğŸ“° News Search</option>
          </select>
          <select id="input-len-topic" class="px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="medium">Standard</option>
            <option value="short">Short</option>
          </select>
        </div>
        <select id="input-level" class="w-full mb-6 px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="elementary">Elementary</option>
            <option value="high" selected>High School</option>
            <option value="adult">Professional</option>
        </select>
        <button onclick="submitTopic()" id="btn-topic" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition">âœ¨ Start Learning</button>
      </div>

      <div id="form-paste" class="hidden">
        <input type="text" id="input-title" class="w-full mb-3 px-4 py-3 border rounded-xl outline-none" placeholder="Title">
        <textarea id="input-content" rows="4" class="w-full mb-4 px-4 py-3 border rounded-xl outline-none" placeholder="Paste English text..."></textarea>
        <select id="input-len-paste" class="w-full mb-4 px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="medium">Standard</option>
        </select>
        <button onclick="submitPaste()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg transition">ğŸš€ Analyze</button>
      </div>
      
      <p id="loading-msg" class="hidden mt-6 text-center text-indigo-600 text-sm font-semibold animate-pulse">ğŸ¤– AI is writing...</p>
    </div>
  </div>

  <div id="view-cards" class="hidden w-full max-w-lg p-4 h-full flex-col justify-center">
    <div class="flex justify-between items-center mb-4 px-2">
      <button onclick="goBackToMenu()" class="text-gray-500 hover:text-indigo-600 font-bold text-sm bg-white px-3 py-1.5 rounded-lg shadow-sm">ğŸ  Home</button>
      <div class="text-center"><h2 id="card-main-title" class="text-xs font-bold text-gray-400 uppercase truncate max-w-[150px]">Lesson</h2><span id="counter" class="font-mono text-indigo-600 font-bold text-sm">1 / 10</span></div>
    </div>

    <div class="relative w-full h-[70vh] perspective-1000 group cursor-pointer" onclick="flipCard(this)">
      <div class="content-box relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl">
        <div class="absolute w-full h-full bg-white rounded-3xl p-6 flex flex-col backface-hidden border border-gray-100">
          <div class="flex-grow overflow-y-auto custom-scroll flex flex-col justify-center">
            <h2 id="card-eng" class="text-2xl leading-relaxed text-gray-800 font-eng text-left">...</h2>
          </div>
          <p class="mt-2 text-center text-gray-300 text-xs uppercase animate-pulse">Tap to check</p>
        </div>
        <div class="absolute w-full h-full bg-slate-800 rounded-3xl p-6 flex flex-col justify-between backface-hidden rotate-y-180 text-white">
          <div class="flex-grow overflow-y-auto custom-scroll pt-4">
            <p id="card-chn" class="text-xl leading-relaxed font-chn text-slate-100 mb-6">...</p>
            <div id="vocab-area" class="border-t border-slate-600 pt-4 hidden"><div id="vocab-list" class="flex flex-wrap gap-2"></div></div>
          </div>
          <div class="mt-2 pt-3 border-t border-slate-600 flex gap-3">
            <button onclick="speakTarget(event)" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm">ğŸ”Š Listen</button>
            <button id="btn-mic" onclick="toggleRecording(event)" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold">ğŸ¤ Speak</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="flex justify-between mt-6 gap-4">
      <button onclick="prevCard()" class="flex-1 bg-white text-gray-700 py-3 rounded-xl font-bold shadow">â† Prev</button>
      <button onclick="nextCard()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">Next â†’</button>
    </div>
  </div>

  <div id="view-review" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center relative">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[85vh] flex flex-col relative border border-gray-100">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 font-eng">ğŸ“– Full Article</h2>
        <button onclick="goBackToMenu()" class="text-gray-400 font-bold text-sm">âœ•</button>
      </div>
      
      <div class="flex-grow overflow-y-auto custom-scroll relative">
         <h3 id="review-title" class="text-xl font-bold text-indigo-600 mb-4 font-eng">Title</h3>
         <div id="review-content" class="prose text-gray-700 font-eng text-lg leading-loose"></div>
         
         <div id="word-popup">
            <div class="flex justify-between items-start mb-1">
                <h4 id="popup-word" class="text-lg font-bold text-indigo-700">Word</h4>
                <button onclick="closePopup()" class="text-gray-300 hover:text-gray-500">Ã—</button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span id="popup-ipa" class="text-xs text-gray-500 font-mono">/ipa/</span>
                <button onclick="playPopupAudio()" class="text-indigo-500 text-xs hover:bg-indigo-50 rounded px-1">ğŸ”Š</button>
            </div>
            <p id="popup-def" class="text-sm text-gray-700 font-chn leading-snug">Loading definition...</p>
            <button id="btn-popup-save" onclick="savePopupWord()" class="mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1.5 rounded transition">
                + Save to Word Bank
            </button>
         </div>
      </div>

      <div class="mt-4 pt-4 border-t border-gray-100 flex gap-3">
        <button id="btn-read-all" onclick="playFullArticle()" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">ğŸ”Š Read All</button>
        <button onclick="goBackToMenu()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">ğŸ  Menu</button>
      </div>
    </div>
  </div>

  <div id="view-wordbank" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[80vh] flex flex-col border border-gray-100">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 font-chn">ğŸ“š æˆ‘çš„ç”Ÿå­—æœ¬</h2>
        <button onclick="goBackToMenu()" class="text-gray-400 text-sm">âœ•</button>
      </div>
      <div id="wordbank-list" class="flex-grow overflow-y-auto custom-scroll space-y-3"><p class="text-center text-gray-400 mt-10">Loading...</p></div>
      <button onclick="loadWordBank()" class="mt-4 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">â†» Refresh</button>
    </div>
  </div>

  <script>
    // ğŸ”¥ å·²ç¶“æ›´æ–°ç‚ºæ‚¨æœ€æ–°çš„å¾Œç«¯ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbzTciZ2Z7Xrmc8IrV-VHqmJMT6rdbnnIbnE1j6YYKDv3yC3Av0fvofThL6pBmvj_GP0MQ/exec"; 

    let currentCards = [], currentIndex = 0, isPlayingFull = false, recognition, isRecording = false;
    let voices = [], wordCache = {}; // å–®å­—å¿«å–
    let currentPopupData = null; // ç•¶å‰å½ˆçª—è³‡æ–™

    // TTS Setup
    function loadVoices() {
      voices = window.speechSynthesis.getVoices();
      const select = document.getElementById('input-voice');
      select.innerHTML = '';
      const eng = voices.filter(v => v.lang.includes('en'));
      (eng.length ? eng : voices).forEach((v, i) => select.add(new Option(`${v.name} (${v.lang})`, i)));
      select.value = voices.findIndex(v => v.name.includes('Google US')) || 0;
    }
    window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

    async function callApi(action, params) {
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, ...params }) });
        const json = await res.json();
        if (json.status === 'error') throw new Error(json.message);
        return json;
      } catch (e) { alert("Error: " + e.message); throw e; }
    }

    // Navigation
    function goBackToMenu() {
      stopFullAudio();
      ['view-cards', 'view-review', 'view-wordbank'].forEach(id => document.getElementById(id).classList.remove('flex'));
      ['view-cards', 'view-review', 'view-wordbank'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById('view-input').classList.remove('hidden');
    }
    function switchTab(mode) {
       document.getElementById('form-topic').classList.toggle('hidden', mode!=='topic');
       document.getElementById('form-paste').classList.toggle('hidden', mode!=='paste');
       document.getElementById('tab-topic').className = mode==='topic'?'border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2':'text-gray-500 px-6 py-2';
       document.getElementById('tab-paste').className = mode==='paste'?'border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2':'text-gray-500 px-6 py-2';
    }

    // Submit & Flow
    function submitTopic() {
       const topic=document.getElementById('input-topic').value; if(!topic)return alert("Enter topic");
       startGen('generate', { topic, level:document.getElementById('input-level').value, len:document.getElementById('input-len-topic').value, scenario:document.getElementById('input-scenario').value });
    }
    function submitPaste() {
       const txt=document.getElementById('input-content').value; if(!txt)return alert("Paste text");
       startGen('import', { title:document.getElementById('input-title').value, content:txt, len:document.getElementById('input-len-paste').value });
    }
    function startGen(act, data) {
        document.getElementById('loading-msg').classList.remove('hidden');
        callApi(act, data).then(res => {
            document.getElementById('loading-msg').classList.add('hidden');
            currentCards = res.data.cards; currentIndex = 0;
            document.getElementById('card-main-title').innerText = res.data.title || 'Lesson';
            document.getElementById('view-input').classList.add('hidden');
            document.getElementById('view-cards').classList.remove('hidden');
            document.getElementById('view-cards').classList.add('flex');
            renderCard();
        });
    }

    // Card View
    function renderCard() {
        const c = currentCards[currentIndex];
        document.getElementById('card-eng').innerText = c.english;
        document.getElementById('card-chn').innerText = c.chinese;
        document.getElementById('counter').innerText = `${currentIndex+1}/${currentCards.length}`;
        
        const vList = document.getElementById('vocab-list');
        if(c.vocabulary && c.vocabulary.length){
            document.getElementById('vocab-area').classList.remove('hidden');
            vList.innerHTML = c.vocabulary.map(v => `<button onclick="event.stopPropagation();saveWord('${v.word}','${v.ipa}','${v.def}',this)" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded-full">+ ${v.word}</button>`).join('');
        } else { document.getElementById('vocab-area').classList.add('hidden'); }
        document.querySelector('.group').classList.remove('flipped');
    }
    function flipCard(el){ if(!isRecording) el.classList.toggle('flipped'); }
    function nextCard(){ if(currentIndex<currentCards.length-1){currentIndex++; renderCard();} else { showReviewPage(); } }
    function prevCard(){ if(currentIndex>0){currentIndex--; renderCard();} }
    function speakTarget(e){ e.stopPropagation(); speak(currentCards[currentIndex].english); }
    function speak(txt){ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(txt); u.lang='en-US'; const v=voices[document.getElementById('input-voice').value]; if(v)u.voice=v; window.speechSynthesis.speak(u); }

    // ğŸ”¥ğŸ”¥ğŸ”¥ å…¨æ–‡é–±è®€èˆ‡é»æ“ŠæŸ¥å­—é‚è¼¯ (Review Page) ğŸ”¥ğŸ”¥ğŸ”¥
    function showReviewPage() {
        document.getElementById('view-cards').classList.add('hidden');
        document.getElementById('view-cards').classList.remove('flex');
        const view = document.getElementById('view-review');
        view.classList.remove('hidden'); view.classList.add('flex');
        
        document.getElementById('review-title').innerText = document.getElementById('card-main-title').innerText;
        const contentDiv = document.getElementById('review-content');
        
        // å°‡æ–‡ç« æ‹†è§£ç‚ºå–®å­—
        const fullText = currentCards.map(c => c.english).join(' ');
        // ç°¡å–®æ–·è©ï¼šä»¥ç©ºæ ¼åˆ†å‰²ï¼Œä¿ç•™æ¨™é»ç¬¦è™Ÿçš„é‚è¼¯æ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡ç”¨ç°¡å–®ç‰ˆ
        // æŠ€å·§ï¼šå°‡æ‰€æœ‰éå­—æ¯å­—ç¬¦è¦–ç‚ºåˆ†éš”ç¬¦ï¼Œä½†ä¿ç•™åœ¨ UI ä¸­æœƒæ¯”è¼ƒè‡ªç„¶
        // ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæˆ‘å€‘å°‡æ¯å€‹å–®å­—åŒ…è£¹åœ¨ span ä¸­
        const words = fullText.split(/(\s+)/); // ä¿ç•™ç©ºæ ¼
        
        contentDiv.innerHTML = words.map(w => {
            if(w.trim().length === 0) return w; // ç©ºæ ¼ç›´æ¥å›å‚³
            // å»é™¤æ¨™é»ä»¥ä¾¿å‚³çµ¦ APIï¼Œä½†é¡¯ç¤ºæ™‚ä¿ç•™
            const rawWord = w.replace(/[^\w']/g, ""); 
            if(!rawWord) return w; 
            return `<span class="clickable-word" onclick="handleWordClick('${rawWord}', this)">${w}</span>`;
        }).join('');
    }

    // è™•ç†å–®å­—é»æ“Š
    async function handleWordClick(word, el) {
        // 1. æ’­æ”¾è²éŸ³
        speak(word);
        
        // 2. é¡¯ç¤º Popup (å®šä½)
        const popup = document.getElementById('word-popup');
        const rect = el.getBoundingClientRect();
        const parentRect = document.getElementById('view-review').getBoundingClientRect();
        
        // è¨ˆç®—ç›¸å°ä½ç½®ï¼Œé¿å…è¢«åˆ‡æ‰
        let top = rect.top - parentRect.top - popup.offsetHeight - 10;
        if(top < 0) top = rect.bottom - parentRect.top + 10; // å¦‚æœä¸Šé¢æ²’ç©ºé–“ï¼Œé¡¯ç¤ºåœ¨ä¸‹é¢
        
        popup.style.top = `${top}px`;
        popup.style.left = `${rect.left - parentRect.left}px`;
        popup.style.display = 'block';
        
        // 3. UI åˆå§‹åŒ–
        document.getElementById('popup-word').innerText = word;
        document.getElementById('popup-ipa').innerText = "...";
        document.getElementById('popup-def').innerText = "Translating...";
        const btn = document.getElementById('btn-popup-save');
        btn.innerText = "+ Save to Word Bank"; btn.disabled = false; btn.className = "mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1.5 rounded transition";
        
        currentPopupData = { word: word, context: currentCards.map(c=>c.english).join(' ').substring(0, 100) }; // ç°¡å–®ä¸Šä¸‹æ–‡

        // 4. æª¢æŸ¥å¿«å– or å‘¼å« API
        if (wordCache[word]) {
            updatePopup(wordCache[word]);
        } else {
            try {
                const res = await callApi('translate', { word: word, context: currentPopupData.context });
                if(res.status === 'success') {
                    wordCache[word] = res.data;
                    updatePopup(res.data);
                } else {
                    document.getElementById('popup-def').innerText = "Translation not found.";
                }
            } catch(e) {
                document.getElementById('popup-def').innerText = "Error loading.";
            }
        }
    }

    function updatePopup(data) {
        document.getElementById('popup-ipa').innerText = data.ipa || '';
        document.getElementById('popup-def').innerText = data.def;
        currentPopupData = { ...currentPopupData, ...data };
    }
    
    function closePopup() { document.getElementById('word-popup').style.display = 'none'; }
    function playPopupAudio() { if(currentPopupData) speak(currentPopupData.word); }
    
    function savePopupWord() {
        if(!currentPopupData || !currentPopupData.def) return;
        const btn = document.getElementById('btn-popup-save');
        btn.innerText = "Saving...";
        callApi('saveVocab', { 
            userId: getUserId(), 
            word: currentPopupData.word, 
            ipa: currentPopupData.ipa, 
            def: currentPopupData.def, 
            ctx: currentPopupData.context, 
            ctxChn: "(From Review)" 
        }).then(() => {
            btn.innerText = "âœ“ Saved"; btn.classList.replace('bg-indigo-600','bg-green-500'); btn.disabled=true;
        });
    }

    // Full Audio
    function playFullArticle() {
        if(isPlayingFull){ stopFullAudio(); return; }
        isPlayingFull=true; document.getElementById('btn-read-all').innerText='ğŸ›‘ Stop'; window.speechSynthesis.cancel();
        currentCards.forEach((c, i) => {
            const u = new SpeechSynthesisUtterance(c.english);
            u.lang='en-US'; const v=voices[document.getElementById('input-voice').value]; if(v)u.voice=v;
            if(i===currentCards.length-1) u.onend = stopFullAudio;
            window.speechSynthesis.speak(u);
        });
    }
    function stopFullAudio(){ window.speechSynthesis.cancel(); isPlayingFull=false; document.getElementById('btn-read-all').innerText='ğŸ”Š Read All'; }

    // Misc
    function getUserId() { let u=localStorage.getItem('uid'); if(!u){u='user_'+Date.now();localStorage.setItem('uid',u);} return u; }
    function openWordBank() { document.getElementById('view-input').classList.add('hidden'); document.getElementById('view-wordbank').classList.remove('hidden'); document.getElementById('view-wordbank').classList.add('flex'); loadWordBank(); }
    function loadWordBank() { 
        callApi('getVocab', { userId: getUserId() }).then(res => {
             const list = document.getElementById('wordbank-list');
             if(!res.data.length) list.innerHTML='<p class="text-center text-gray-400 mt-4">No words yet.</p>';
             else list.innerHTML = res.data.map(w => `<div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-center"><div><div class="flex items-center gap-2"><span class="text-indigo-600 font-bold" onclick="speak('${w.word}')">ğŸ”Š ${w.word}</span><span class="text-xs text-gray-500">${w.ipa}</span></div><p class="text-sm text-gray-600">${w.def}</p></div><button onclick="delWord('${w.id}',this)" class="text-gray-300 hover:text-red-500">ğŸ—‘ï¸</button></div>`).join('');
        });
    }
    function saveWord(w,i,d,btn){ btn.innerText="âœ“"; btn.disabled=true; callApi('saveVocab',{userId:getUserId(),word:w,ipa:i,def:d,ctx:currentCards[currentIndex].english,ctxChn:currentCards[currentIndex].chinese}); }
    function delWord(id,btn){ if(confirm("Delete?")) callApi('delVocab',{userId:getUserId(),id}).then(()=>btn.closest('div').remove()); }

    // Close popup on click outside
    document.addEventListener('click', function(e) {
        const popup = document.getElementById('word-popup');
        if (popup.style.display === 'block' && !popup.contains(e.target) && !e.target.classList.contains('clickable-word')) {
            closePopup();
        }
    });
  </script>
</body>
</html>
