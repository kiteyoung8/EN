<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GemArticle - Vercel Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* å­—é«”è¨­å®š */
    .font-eng { font-family: 'Merriweather', serif; }
    .font-chn { font-family: 'Noto Sans TC', sans-serif; }
    
    /* 3D ç¿»è½‰å¡ç‰‡ */
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    .group.flipped .content-box { transform: rotateY(180deg); }

    /* è‡ªè¨‚æ²è»¸ */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    
    /* Tabs */
    .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: bold; }
    .tab-inactive { color: #6b7280; }
    
    /* å‹•ç•« */
    .listening-pulse { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); animation: pulse-red 1.5s infinite; }
    .playing-pulse { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); animation: pulse-blue 1.5s infinite; }
    @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(225, 29, 72, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }
    @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center font-sans">

  <div id="view-input" class="w-full max-w-lg p-6 transition-all duration-300">
    <div class="bg-white rounded-2xl shadow-xl p-8 relative">
      
      <button onclick="openWordBank()" class="absolute top-4 right-4 text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition" title="My Word Bank">
        <span class="text-xl">ğŸ“š</span>
      </button>

      <div class="flex justify-center mb-6 border-b border-gray-200">
        <button onclick="switchTab('topic')" id="tab-topic" class="tab-active px-6 py-2 transition-all">âœ¨ AI ç”Ÿæˆ</button>
        <button onclick="switchTab('paste')" id="tab-paste" class="tab-inactive px-6 py-2 transition-all">ğŸ“‹ è²¼ä¸Šæ–‡ç« </button>
      </div>

      <div class="mb-6 bg-gray-50 p-3 rounded-xl border border-gray-200">
         <label class="block text-xs font-bold text-gray-500 uppercase mb-1">ğŸ—£ï¸ é¸æ“‡äººè² (Voice)</label>
         <select id="input-voice" class="w-full bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm text-gray-700 outline-none">
            <option value="">Loading voices...</option>
         </select>
      </div>

      <div id="form-topic" class="block">
        <div class="text-center mb-4">
          <h1 class="text-2xl font-bold text-gray-800 font-chn">è‹±èªå­¸ç¿’åŠ©ç†</h1>
          <p class="text-gray-500 text-sm">è¼¸å…¥ä¸»é¡Œï¼Œå³åˆ»ç”Ÿæˆæ•™æã€‚</p>
        </div>
        <input type="text" id="input-topic" class="w-full mb-4 px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚: Travel, Tech...">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æƒ…å¢ƒ Scenario</label>
            <select id="input-scenario" class="w-full px-3 py-3 border rounded-xl bg-white outline-none text-sm text-indigo-700 font-semibold">
              <option value="article">ğŸ“˜ çŸ­æ–‡ (Article)</option>
              <option value="conversation">ğŸ’¬ å°è©± (Dialogue)</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">åˆ†æ®µ Length</label>
            <select id="input-len-topic" class="w-full px-3 py-3 border rounded-xl bg-white outline-none text-sm">
              <option value="medium" selected>æ¨™æº– (Standard)</option>
              <option value="short">çŸ­å¥ (Short)</option>
              <option value="long">é•·æ®µè½ (Long)</option>
            </select>
          </div>
        </div>
        <div class="mb-6">
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">é›£åº¦ Level</label>
          <select id="input-level" class="w-full px-3 py-3 border rounded-xl bg-white outline-none text-sm">
            <option value="elementary">US Elementary</option>
            <option value="middle">US Middle School</option>
            <option value="high" selected>US High School</option>
            <option value="university">University</option>
            <option value="adult">Adult Professional</option>
          </select>
        </div>
        <button onclick="submitTopic()" id="btn-topic" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
          <span>âœ¨ ç”Ÿæˆä¸¦é–‹å§‹</span>
        </button>
      </div>

      <div id="form-paste" class="hidden">
        <div class="text-center mb-4">
          <h1 class="text-xl font-bold text-gray-800 font-chn">è‡ªè¨‚é–±è®€</h1>
        </div>
        <input type="text" id="input-title" class="w-full mb-3 px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="æ–‡ç« æ¨™é¡Œ">
        <textarea id="input-content" rows="4" class="w-full mb-4 px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="è²¼ä¸Šè‹±æ–‡æ–‡ç« ..."></textarea>
        <div class="mb-4">
          <label class="block text-xs font-bold text-gray-500 uppercase mb-1">åˆ†æ®µé•·åº¦ Length</label>
          <select id="input-len-paste" class="w-full px-3 py-3 border rounded-xl bg-white outline-none text-sm">
            <option value="medium" selected>æ¨™æº– (Standard)</option>
            <option value="short">çŸ­å¥ (Short)</option>
            <option value="long">é•·æ®µè½ (Long)</option>
          </select>
        </div>
        <button onclick="submitPaste()" id="btn-paste" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl transition shadow-lg flex justify-center items-center gap-2">
          <span>ğŸš€ åˆ†ææ–‡ç« </span>
        </button>
      </div>
      <p id="loading-msg" class="hidden mt-6 text-center text-indigo-600 text-sm font-semibold animate-pulse">ğŸ¤– AI æ­£åœ¨ç·¨å¯«æ•™æ...</p>
    </div>
  </div>

  <div id="view-cards" class="hidden w-full max-w-lg p-4 h-full flex-col justify-center">
    <div class="flex justify-between items-center mb-4 px-2">
      <button onclick="goBackToMenu()" class="flex items-center gap-1 text-gray-500 hover:text-indigo-600 font-bold text-sm transition bg-white px-3 py-1.5 rounded-lg shadow-sm hover:shadow">
        <span>ğŸ </span><span>Home</span>
      </button>
      <div class="text-center">
        <h2 id="card-main-title" class="text-xs font-bold text-gray-400 uppercase truncate max-w-[150px]">Lesson</h2>
        <span id="counter" class="font-mono text-indigo-600 font-bold text-sm">1 / 10</span>
      </div>
    </div>

    <div class="relative w-full h-[70vh] perspective-1000 group cursor-pointer" onclick="flipCard(this)">
      <div class="content-box relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl">
        <div class="absolute w-full h-full bg-white rounded-3xl p-6 flex flex-col backface-hidden border border-gray-100">
          <div class="flex-grow overflow-y-auto custom-scroll flex flex-col justify-start pt-4">
            <span class="text-xs font-bold text-gray-300 uppercase mb-2 tracking-widest">English</span>
            <h2 id="card-eng" class="text-2xl md:text-3xl leading-relaxed text-gray-800 font-eng text-left pb-4">...</h2>
            <div id="card-tips" class="mt-2 text-sm text-indigo-500 font-mono bg-indigo-50 p-3 rounded-lg hidden"></div>
          </div>
          <p class="mt-2 text-center text-gray-300 text-xs uppercase animate-pulse">Tap to check</p>
        </div>
        <div class="absolute w-full h-full bg-slate-800 rounded-3xl p-6 flex flex-col justify-between backface-hidden rotate-y-180 text-white">
          <div class="flex-grow flex flex-col justify-start overflow-y-auto custom-scroll pt-2">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Translation</h3>
            <p id="card-chn" class="text-xl leading-relaxed font-chn text-slate-100 mb-6">...</p>
            <div id="vocab-area" class="border-t border-slate-600 pt-4 hidden pb-4">
               <h3 class="text-xs font-bold text-indigo-300 uppercase mb-2">Save Words</h3>
               <div id="vocab-list" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div class="mt-2 pt-3 border-t border-slate-600">
            <div id="feedback-area" class="hidden text-center mb-3">
               <p id="status-text" class="text-xs text-slate-400 italic mb-1">...</p>
               <span id="score-badge" class="px-3 py-1 rounded-full text-sm font-bold bg-gray-600">Score</span>
            </div>
            <div class="flex gap-3">
              <button onclick="speakTarget(event)" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm">ğŸ”Š Listen</button>
              <button id="btn-mic" onclick="toggleRecording(event)" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg border-b-4 border-indigo-700 active:border-b-0 active:translate-y-1 transition-all">ğŸ¤ Speak</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex justify-between mt-6 gap-4">
      <button onclick="prevCard()" class="flex-1 bg-white text-gray-700 py-3 rounded-xl font-bold shadow hover:bg-gray-50">â† Previous</button>
      <button onclick="nextCard()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700">Next â†’</button>
    </div>
  </div>

  <div id="view-wordbank" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center animate-fade-in">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[80vh] flex flex-col border border-gray-100">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 font-chn">ğŸ“š æˆ‘çš„ç”Ÿå­—æœ¬</h2>
        <button onclick="goBackToMenu()" class="text-gray-400 hover:text-indigo-600 font-bold text-sm">âœ• Close</button>
      </div>
      <div id="wordbank-list" class="flex-grow overflow-y-auto custom-scroll space-y-3">
         <p class="text-center text-gray-400 mt-10">Loading words...</p>
      </div>
      <button onclick="loadWordBank()" class="mt-4 w-full bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-100 transition">â†» Refresh List</button>
    </div>
  </div>

  <div id="view-review" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center animate-fade-in">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[80vh] flex flex-col relative border border-gray-100">
      <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100">
        <h2 class="text-2xl font-bold text-gray-800 font-eng">Lesson Review</h2>
        <button onclick="goBackToMenu()" class="text-gray-400 hover:text-indigo-600 font-bold text-sm">âœ• Close</button>
      </div>
      <div class="flex-grow overflow-y-auto custom-scroll pr-2">
         <h3 id="review-title" class="text-xl font-bold text-indigo-600 mb-4 font-eng">Title</h3>
         <div id="review-content" class="prose text-gray-700 font-eng text-lg leading-relaxed space-y-4"></div>
      </div>
      <div class="mt-6 pt-4 border-t border-gray-100 flex flex-col gap-3">
        <button id="btn-read-all" onclick="playFullArticle()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-bold shadow-lg flex justify-center items-center gap-2 transition-all">
          <span>ğŸ”Š Read Full Article</span>
        </button>
        <button onclick="goBackToMenu()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-600 py-3 rounded-xl font-bold transition">
          ğŸ  Back to Menu
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // âš ï¸ è¨­å®šå€ï¼šæ‚¨çš„ Google Apps Script ç¶²å€
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbyiNl4M6V-t2E55pM9EZ4efcSxHbhidAIkHsZj1jYJX6eHUPSEbhCyD1RB_K0o70diIOw/exec"; 

    // === API å‘¼å«æ ¸å¿ƒ ===
    async function callApi(action, params = {}) {
      const formData = { action: action, ...params };
      try {
        const response = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(formData)
        });
        const json = await response.json();
        if (json.status === 'error') throw new Error(json.message);
        return json;
      } catch(e) {
        throw new Error("Connection failed: " + e.message);
      }
    }

    // === Variables ===
    let currentCards = [], currentIndex = 0;
    let recognition, isRecording = false, finalTranscript = '', silenceTimer = null;
    const SILENCE_DELAY = 2000;
    let isPlayingFull = false, voices = [], selectedVoice = null;

    // === USER ID ===
    function getUserId() {
      let uid = localStorage.getItem('gem_reader_uid');
      if (!uid) { uid = 'user_' + Date.now(); localStorage.setItem('gem_reader_uid', uid); }
      return uid;
    }

    // === Voice Logic ===
    function loadVoices() {
      voices = window.speechSynthesis.getVoices();
      const eng = voices.filter(v => v.lang.includes('en'));
      const s = document.getElementById('input-voice'); s.innerHTML = '';
      if(eng.length===0){ s.add(new Option("Default English","")); return; }
      eng.forEach(v => s.add(new Option(`${v.name}`, voices.indexOf(v))));
      s.value = voices.indexOf(eng.find(v => v.name.includes('Google US')) || eng[0]);
    }
    window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices();

    function getSpeechUtterance(text) {
      const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9;
      const vIdx = document.getElementById('input-voice').value;
      if (vIdx && voices[vIdx]) u.voice = voices[vIdx];
      return u;
    }

    // === Navigation Logic ===
    function goBackToMenu() {
      try { stopRecordingManually(); } catch(e) {}
      try { stopFullAudio(); } catch(e) {}
      window.speechSynthesis.cancel();
      ['view-cards', 'view-review', 'view-wordbank'].forEach(id => {
          const el = document.getElementById(id); el.classList.add('hidden'); el.classList.remove('flex');
      });
      document.getElementById('view-input').classList.remove('hidden');
    }

    // === Word Bank ===
    function openWordBank() {
      document.getElementById('view-input').classList.add('hidden');
      const wb = document.getElementById('view-wordbank'); wb.classList.remove('hidden'); wb.classList.add('flex');
      loadWordBank();
    }
    function loadWordBank() {
      document.getElementById('wordbank-list').innerHTML = '<p class="text-center text-gray-400 mt-10">Loading...</p>';
      callApi('getVocab', { userId: getUserId() })
        .then(data => renderWordBank(data)) 
        .catch(e => alert(e.message));
    }
    function renderWordBank(words) {
      const c = document.getElementById('wordbank-list');
      if (!words || !words.length) { c.innerHTML = '<p class="text-center text-gray-400 mt-10">No words saved.</p>'; return; }
      c.innerHTML = words.map(w => {
         const ctx = (w.context||"").replace(/'/g, "\\'");
         return `<div class="bg-gray-50 p-4 rounded-xl border border-gray-100 group relative">
           <div class="flex justify-between"><div onclick="speakSimpleWord('${w.word}')" class="cursor-pointer"><h3 class="font-bold text-gray-800">${w.word} ğŸ”Š</h3><p class="text-sm text-gray-600">${w.def}</p></div><button onclick="deleteWord('${w.id}',this)" class="text-gray-300 hover:text-red-500">ğŸ—‘ï¸</button></div>
           <div class="mt-2 pt-2 border-t cursor-pointer" onclick="speakSimpleWord('${ctx}')"><p class="text-xs text-gray-500 italic">"${w.context}"</p><p class="text-xs text-gray-400">${w.contextChn||''}</p></div></div>`;
      }).join('');
    }
    function deleteWord(id, btn) {
      if(!confirm("Delete?")) return;
      btn.closest('div.bg-gray-50').remove();
      callApi('delVocab', { userId: getUserId(), id: id });
    }
    function saveWord(w, i, d, btn) {
      const c = currentCards[currentIndex];
      btn.innerText="âœ“"; btn.disabled=true; btn.classList.replace('bg-indigo-600','bg-green-500');
      callApi('saveVocab', {
        userId: getUserId(), word: w, ipa: i, def: d, ctx: c.english, ctxChn: c.chinese
      });
    }

    // === Core Logic ===
    function switchTab(m) {
       document.getElementById('form-topic').classList.toggle('hidden', m!=='topic');
       document.getElementById('form-paste').classList.toggle('hidden', m!=='paste');
       document.getElementById('tab-topic').className = m==='topic' ? 'tab-active px-6 py-2' : 'tab-inactive px-6 py-2';
       document.getElementById('tab-paste').className = m==='paste' ? 'tab-active px-6 py-2' : 'tab-inactive px-6 py-2';
    }
    function setLoading(b) { document.getElementById('loading-msg').classList.toggle('hidden', !b); }
    
    function submitTopic() { 
       const t=document.getElementById('input-topic').value; if(!t)return alert("Topic!"); setLoading(true);
       callApi('generate', {
         topic: t, 
         level: document.getElementById('input-level').value, 
         len: document.getElementById('input-len-topic').value, 
         scenario: document.getElementById('input-scenario').value
       }).then(res => onSuccess(res)).catch(onFailure);
    }
    
    function submitPaste() {
       const t=document.getElementById('input-content').value; if(!t)return alert("Content!"); setLoading(true);
       callApi('import', {
         title: document.getElementById('input-title').value, 
         content: t, 
         len: document.getElementById('input-len-paste').value
       }).then(res => onSuccess(res)).catch(onFailure);
    }

    function onSuccess(res) {
       setLoading(false); currentCards = res.data.cards; currentIndex = 0;
       document.getElementById('card-main-title').innerText = res.data.title || 'Lesson';
       document.getElementById('view-input').classList.add('hidden');
       const vc = document.getElementById('view-cards'); vc.classList.remove('hidden'); vc.classList.add('flex');
       renderCard();
    }
    function onFailure(e) { setLoading(false); alert("Error: "+e.message); }

    // === Review & UI Helpers ===
    function showReviewPage() {
      ['view-cards', 'view-input'].forEach(id => document.getElementById(id).classList.add('hidden'));
      const rv = document.getElementById('view-review'); rv.classList.remove('hidden'); rv.classList.add('flex');
      document.getElementById('review-title').innerText = document.getElementById('card-main-title').innerText;
      const content = document.getElementById('review-content');
      const isDlg = document.getElementById('input-scenario').value === 'conversation';
      content.innerHTML = isDlg ? currentCards.map(c=>`<p class="bg-gray-50 p-2 rounded mb-2"><strong>${c.english}</strong></p>`).join('') : `<p>${currentCards.map(c=>c.english).join(' ')}</p>`;
    }
    function speakSimpleWord(t) { window.speechSynthesis.cancel(); window.speechSynthesis.speak(getSpeechUtterance(t)); }
    function playFullArticle() {
      if(isPlayingFull) { stopFullAudio(); return; }
      isPlayingFull = true; document.getElementById('btn-read-all').innerHTML = 'ğŸ›‘ Stop';
      window.speechSynthesis.cancel();
      currentCards.forEach((c, i) => {
        const u = getSpeechUtterance(c.english);
        if(i === currentCards.length - 1) u.onend = stopFullAudio;
        window.speechSynthesis.speak(u);
      });
    }
    function stopFullAudio() {
      window.speechSynthesis.cancel(); isPlayingFull = false;
      document.getElementById('btn-read-all').innerHTML = 'ğŸ”Š Read Full Article';
    }
    function renderCard() {
      const c = currentCards[currentIndex];
      document.getElementById('card-eng').innerText = c.english;
      document.getElementById('card-chn').innerText = c.chinese;
      document.getElementById('counter').innerText = `${currentIndex+1}/${currentCards.length}`;
      const vArea = document.getElementById('vocab-area');
      if(c.vocabulary && c.vocabulary.length) {
         vArea.classList.remove('hidden');
         document.getElementById('vocab-list').innerHTML = c.vocabulary.map(v => `<button onclick="event.stopPropagation();saveWord('${v.word}','${v.ipa}','${v.def}',this)" class="px-3 py-1 bg-indigo-600 text-white text-xs rounded-full shadow">+ ${v.word}</button>`).join('');
      } else vArea.classList.add('hidden');
      const tips = document.getElementById('card-tips');
      tips.innerText = c.ipa_notes ? "ğŸ’¡ "+c.ipa_notes : ""; tips.classList.toggle('hidden', !c.ipa_notes);
      document.querySelector('.group').classList.remove('flipped'); document.getElementById('feedback-area').classList.add('hidden');
    }
    function flipCard(el) { if(!isRecording) el.classList.toggle('flipped'); }
    function nextCard() { if(currentIndex<currentCards.length-1) { currentIndex++; renderCard(); } else showReviewPage(); }
    function prevCard() { if(currentIndex>0) { currentIndex--; renderCard(); } }
    function speakTarget(e) { e.stopPropagation(); window.speechSynthesis.speak(getSpeechUtterance(currentCards[currentIndex].english)); }

    // === Speech Rec ===
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition(); recognition.continuous=true; recognition.interimResults=true; recognition.lang='en-US';
      recognition.onstart = () => { isRecording=true; updateMicBtn(true); finalTranscript=''; document.getElementById('status-text').innerText="Listening..."; document.getElementById('feedback-area').classList.remove('hidden'); };
      recognition.onend = () => { if(isRecording) { isRecording=false; updateMicBtn(false); } };
      recognition.onresult = (e) => {
         let interim=''; let final='';
         for(let i=e.resultIndex; i<e.results.length; ++i) e.results[i].isFinal ? final+=e.results[i][0].transcript : interim+=e.results[i][0].transcript;
         finalTranscript += final;
         document.getElementById('status-text').innerText = `"${(finalTranscript+interim).slice(0,40)}..."`;
         if(silenceTimer) clearTimeout(silenceTimer);
         silenceTimer = setTimeout(() => { stopAndScore(finalTranscript+interim); }, SILENCE_DELAY);
      };
    }
    function toggleRecording(e) { e.stopPropagation(); if(isRecording) recognition.stop(); else recognition.start(); }
    function stopAndScore(txt) { if(!isRecording)return; recognition.stop(); isRecording=false; updateMicBtn(false); evaluate(txt, currentCards[currentIndex].english); }
    function stopRecordingManually() { if(silenceTimer) clearTimeout(silenceTimer); if(recognition) recognition.stop(); isRecording=false; updateMicBtn(false); }
    function updateMicBtn(b) { const btn=document.getElementById('btn-mic'); btn.innerText=b?'ğŸ›‘':'ğŸ¤ Speak'; btn.className=b?'bg-rose-500 text-white py-3 rounded-xl shadow-lg listening-pulse':'flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg border-b-4 border-indigo-700 active:border-b-0 active:translate-y-1'; }
    function evaluate(s, t) {
       const sW=s.toLowerCase().split(/\s+/), tW=t.toLowerCase().split(/\s+/); let hit=0; tW.forEach(w=>{ if(sW.includes(w.replace(/[^\w]/g,''))) hit++; });
       const score = Math.min(100, Math.round((hit/tW.length)*100));
       const b = document.getElementById('score-badge'); b.innerText = score>=80 ? `Perfect (${score}%)` : `Try Again (${score}%)`;
       b.className = score>=80 ? "px-3 py-1 bg-green-500 text-white rounded-full text-sm" : "px-3 py-1 bg-yellow-500 text-white rounded-full text-sm";
    }
  </script>
</body>
</html>