<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GemArticle - AI è‹±èªå­¸ç¿’åŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    .font-eng { font-family: 'Merriweather', serif; }
    .font-chn { font-family: 'Noto Sans TC', sans-serif; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    .group.flipped .content-box { transform: rotateY(180deg); }

    .clickable-word {
        cursor: pointer; padding: 2px 0; border-radius: 4px; transition: background-color 0.2s;
    }
    .clickable-word:hover {
        background-color: #e0e7ff; color: #4338ca; text-decoration: underline;
    }

    #word-popup {
        position: absolute; z-index: 50; background: white; border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;
        padding: 12px; min-width: 220px; display: none;
    }
    #word-popup::after {
        content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%) rotate(45deg);
        width: 12px; height: 12px; background: white; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center font-sans">

  <div id="view-login" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex flex-col items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
        <h1 class="text-2xl font-bold text-indigo-700 mb-6">ğŸ‘‹ æ­¡è¿å›ä¾†</h1>
        <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-4 text-center" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
        <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg">é€²å…¥ç³»çµ±</button>
    </div>
  </div>

  <div id="view-input" class="hidden w-full max-w-lg p-6">
    <div class="bg-white rounded-2xl shadow-xl p-8 relative">
      <div class="absolute top-4 right-4 flex gap-2">
        <button onclick="openLibrary()" title="æ–‡ç« åº«" class="text-xl">ğŸ“‚</button>
        <button onclick="openWordBank()" title="ç”Ÿå­—æœ¬" class="text-xl">ğŸ“š</button>
      </div>
      <div class="absolute top-4 left-4 flex gap-2 items-center">
        <span id="display-user" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">Guest</span>
        <button onclick="handleLogout()" class="text-xs text-red-400">ç™»å‡º</button>
      </div>

      <div class="flex justify-center mt-6 mb-6 border-b">
        <button onclick="switchTab('topic')" id="tab-topic" class="border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2">âœ¨ AI ç”Ÿæˆ</button>
        <button onclick="switchTab('paste')" id="tab-paste" class="text-gray-500 px-6 py-2">ğŸ“‹ è²¼ä¸Šæ–‡ç« </button>
      </div>

      <div class="mb-6 bg-gray-50 p-3 rounded-xl border">
         <label class="block text-xs font-bold text-gray-400 uppercase mb-2">ğŸ—£ï¸ å‚™æ´æœ—è®€èªéŸ³ (FALLBACK VOICE)</label>
         <select id="input-voice" class="w-full bg-white border rounded-lg px-2 py-2 text-sm outline-none"></select>
      </div>

      <div id="form-topic" class="block">
        <input type="text" id="input-topic" class="w-full mb-4 px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ä¸»é¡Œ (e.g., æ—…éŠ, AI)">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <select id="input-scenario" class="px-3 py-3 border rounded-xl bg-white text-sm text-indigo-700 font-semibold">
            <option value="article">ğŸ“˜ çŸ­æ–‡</option>
            <option value="conversation">ğŸ’¬ å°è©±</option>
            <option value="news">ğŸ“° æ–°èæœå°‹</option>
          </select>
          <select id="input-level" class="px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="elementary">åˆç´š</option>
            <option value="high" selected>é«˜ä¸­</option>
            <option value="adult">å°ˆæ¥­</option>
          </select>
        </div>
        <button onclick="submitTopic()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition">âœ¨ é–‹å§‹ç”Ÿæˆ</button>
      </div>

      <div id="form-paste" class="hidden">
        <input type="text" id="input-title" class="w-full mb-3 px-4 py-3 border rounded-xl" placeholder="æ–‡ç« æ¨™é¡Œ">
        <textarea id="input-content" rows="4" class="w-full mb-4 px-4 py-3 border rounded-xl" placeholder="è²¼ä¸Šè‹±æ–‡æ–‡ç« ..."></textarea>
        <button onclick="submitPaste()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">ğŸš€ é–‹å§‹åˆ†æ</button>
      </div>
      <p id="loading-msg" class="hidden mt-6 text-center text-indigo-600 animate-pulse">ğŸ¤– AI æ­£åœ¨åˆæˆä¸­ (é€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“)...</p>
    </div>
  </div>

  <div id="view-cards" class="hidden w-full max-w-lg p-4 h-full flex-col justify-center">
    </div>

  <script>
    // ğŸ”¥ é‡è¦ï¼šè«‹ç¢ºä¿é€™æ˜¯æ‚¨æœ€æ–°çš„ GAS éƒ¨ç½²ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbzTciZ2Z7Xrmc8IrV-VHqmJMT6rdbnnIbnE1j6YYKDv3yC3Av0fvofThL6pBmvj_GP0MQ/exec";

    let currentCards = [], currentIndex = 0, isPlayingFull = false;
    let currentArticleText = "", currentArticleChinese = "", currentArticleTitle = "";
    let currentUserId = "", voices = [];

    // --- ğŸ™ï¸ æ ¸å¿ƒï¼šAI å—“éŸ³ + å‚™æ´æ¨¡å¼ ---
    async function speak(txt, version = 'A_Professional') {
        if (!txt) return;
        window.speechSynthesis.cancel();
        const oldAudio = document.getElementById('ai-audio-player');
        if (oldAudio) oldAudio.pause();

        try {
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: 'tts', text: txt, version: version })
            });
            const json = await res.json();

            if (json.status === 'success' && json.audioUrl) {
                let player = document.getElementById('ai-audio-player') || document.createElement('audio');
                player.id = 'ai-audio-player';
                if (!player.parentElement) document.body.appendChild(player);
                player.src = json.audioUrl;
                player.play();
            } else { throw new Error("TTS Failed"); }
        } catch (e) {
            console.warn("å‚™æ´æ¨¡å¼å•Ÿå‹•", e.message);
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US'; u.rate = 0.9;
            const vIdx = document.getElementById('input-voice').value;
            if (voices[vIdx]) u.voice = voices[vIdx];
            window.speechSynthesis.speak(u);
        }
    }

    // --- ğŸ› ï¸ ä¿®æ­£é‡é»ï¼šç¢ºä¿ submitTopic å‘¼å« startGen ---
    function submitTopic() {
        const t = document.getElementById('input-topic').value;
        if(!t) return alert("è«‹è¼¸å…¥ä¸»é¡Œ");
        // ä¿®æ­£åŸæœ¬ handleTopicGeneration is not defined çš„éŒ¯èª¤
        startGen('generate', { 
            topic: t, 
            level: document.getElementById('input-level').value, 
            len: 'medium', 
            scenario: document.getElementById('input-scenario').value 
        });
    }

    function startGen(act, data) {
        document.getElementById('loading-msg').classList.remove('hidden');
        callApi(act, data).then(res => {
            document.getElementById('loading-msg').classList.add('hidden');
            currentCards = res.data.cards; currentIndex = 0;
            currentArticleText = currentCards.map(c => c.english).join(' ');
            currentArticleTitle = res.data.title || 'New Lesson';
            
            document.getElementById('view-input').classList.add('hidden');
            document.getElementById('view-cards').classList.remove('hidden');
            document.getElementById('view-cards').classList.add('flex');
            // renderCard(); // éœ€ç¢ºä¿ renderCard å‡½å¼å­˜åœ¨
        });
    }

    async function callApi(action, params) {
        try {
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, ...params }) });
            const json = await res.json();
            if (json.status === 'error') throw new Error(json.message);
            return json;
        } catch (e) { alert(e.message); throw e; }
    }

    // åˆå§‹åŒ–èˆ‡å…¶ä»–è¼”åŠ©å‡½å¼ (çœç•¥) ...
    function init() { /* åŒå‰ */ }
    window.onload = init;
  </script>
</body>
</html>
