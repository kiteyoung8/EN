// --- å…¨åŸŸè®Šæ•¸ ---
let voices = [];
let currentCards = [], currentIndex = 0;
let isPlayingFull = false;
let currentArticleText = "", currentArticleTitle = "";

// --- ğŸ™ï¸ æ ¸å¿ƒï¼šAI æ’­éŸ³å“¡æœ—è®€ (æ¨¡ä»¿æ°‘èˆªæ’­éŸ³) ---
async function speak(txt, version = 'A_Professional') {
    if (!txt) return;

    // åœæ­¢æ‰€æœ‰èˆŠè²éŸ³
    window.speechSynthesis.cancel();
    const oldAudio = document.getElementById('ai-audio-player');
    if (oldAudio) oldAudio.pause();

    try {
        // å‘ GAS ç™¼é€ TTS è«‹æ±‚
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ 
                action: 'tts', 
                text: txt, 
                version: version 
            })
        });
        const json = await res.json();

        if (json.status === 'success' && json.audioUrl) {
            // å»ºç«‹æˆ–å–å¾—æ’­æ”¾å™¨
            let player = document.getElementById('ai-audio-player');
            if (!player) {
                player = document.createElement('audio');
                player.id = 'ai-audio-player';
                document.body.appendChild(player);
            }
            player.src = json.audioUrl;
            player.play();
            console.log("ğŸ”Š æ­£åœ¨æ’­æ”¾ AI å…‹éš†è²éŸ³...");
        } else {
            throw new Error("AI å—“å­å›æ‡‰ç•°å¸¸");
        }
    } catch (e) {
        console.warn("å‚™æ´æ¨¡å¼ï¼šä½¿ç”¨ç€è¦½å™¨å…§å»ºè²éŸ³", e.message);
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-US';
        u.rate = 0.9; // é è¨­è¼ƒæ…¢èªé€Ÿ
        window.speechSynthesis.speak(u);
    }
}

// --- ğŸ“– å…¨æ–‡æœ—è®€é‚è¼¯ ---
function playFullArticle() {
    if(isPlayingFull){ 
        stopFullAudio(); 
        return; 
    }
    isPlayingFull = true; 
    document.getElementById('btn-read-all').innerText = 'ğŸ›‘ åœæ­¢æœ—è®€ (Stop)'; 
    
    // ç›´æ¥å°‡å…¨æ–‡å‚³çµ¦ AI å—“å­è™•ç†ï¼Œæ•ˆæœæœ€è‡ªç„¶
    const fullText = currentArticleTitle + ". " + currentArticleText;
    speak(fullText, 'B_Philosophical'); 
}

function stopFullAudio() {
    window.speechSynthesis.cancel();
    const player = document.getElementById('ai-audio-player');
    if (player) player.pause();
    isPlayingFull = false;
    document.getElementById('btn-read-all').innerText = 'ğŸ”Š å…¨æ–‡æœ—è®€ (è‹±æ–‡)';
}

// ... å…¶é¤˜ callApi, handleLogin, submitTopic ç­‰å‡½å¼è«‹ä¿ç•™åŸç‹€ ...
