<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GemArticle - AI è‹±èªå­¸ç¿’åŠ©æ‰‹</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    .font-eng { font-family: 'Merriweather', serif; }
    .font-chn { font-family: 'Noto Sans TC', sans-serif; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    .group.flipped .content-box { transform: rotateY(180deg); }

    .clickable-word {
        cursor: pointer; padding: 2px 0; border-radius: 4px; transition: background-color 0.2s;
    }
    .clickable-word:hover {
        background-color: #e0e7ff; color: #4338ca; text-decoration: underline;
    }

    #word-popup {
        position: absolute; z-index: 50; background: white; border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;
        padding: 12px; min-width: 220px; display: none;
    }
    #word-popup::after {
        content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%) rotate(45deg);
        width: 12px; height: 12px; background: white; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center font-sans">

  <div id="view-login" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex flex-col items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
        <h1 class="text-2xl font-bold text-indigo-700 mb-6">ğŸ‘‹ æ­¡è¿å›ä¾†</h1>
        <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-4 text-center" placeholder="è¼¸å…¥æ‚¨çš„å§“å">
        <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg">é€²å…¥ç³»çµ±</button>
    </div>
  </div>

  <div id="view-input" class="hidden w-full max-w-lg p-6">
    <div class="bg-white rounded-2xl shadow-xl p-8 relative">
      <div class="absolute top-4 right-4 flex gap-2">
        <button onclick="openLibrary()" title="æ–‡ç« åº«" class="text-xl">ğŸ“‚</button>
        <button onclick="openWordBank()" title="ç”Ÿå­—æœ¬" class="text-xl">ğŸ“š</button>
      </div>
      <div class="absolute top-4 left-4 flex gap-2 items-center">
        <span id="display-user" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">Guest</span>
        <button onclick="handleLogout()" class="text-xs text-red-400">ç™»å‡º</button>
      </div>

      <div class="flex justify-center mt-6 mb-6 border-b">
        <button onclick="switchTab('topic')" id="tab-topic" class="border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2">âœ¨ AI ç”Ÿæˆ</button>
        <button onclick="switchTab('paste')" id="tab-paste" class="text-gray-500 px-6 py-2">ğŸ“‹ è²¼ä¸Šæ–‡ç« </button>
      </div>

      <div class="mb-6 bg-gray-50 p-3 rounded-xl border">
         <label class="block text-xs font-bold text-gray-400 uppercase mb-2">ğŸ—£ï¸ å‚™æ´æœ—è®€èªéŸ³ (Fallback Voice)</label>
         <select id="input-voice" class="w-full bg-white border rounded-lg px-2 py-2 text-sm outline-none"></select>
      </div>

      <div id="form-topic" class="block">
        <input type="text" id="input-topic" class="w-full mb-4 px-4 py-3 border rounded-xl" placeholder="ä¸»é¡Œ (e.g., æ—…éŠ, AI)">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <select id="input-scenario" class="px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="article">ğŸ“˜ çŸ­æ–‡</option>
            <option value="conversation">ğŸ’¬ å°è©±</option>
            <option value="news">ğŸ“° æ–°èæœå°‹</option>
          </select>
          <select id="input-level" class="px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="elementary">åˆç´š</option>
            <option value="high" selected>é«˜ä¸­</option>
            <option value="adult">å°ˆæ¥­</option>
          </select>
        </div>
        <button onclick="submitTopic()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg">âœ¨ é–‹å§‹ç”Ÿæˆ</button>
      </div>

      <div id="form-paste" class="hidden">
        <input type="text" id="input-title" class="w-full mb-3 px-4 py-3 border rounded-xl" placeholder="æ–‡ç« æ¨™é¡Œ">
        <textarea id="input-content" rows="4" class="w-full mb-4 px-4 py-3 border rounded-xl" placeholder="è²¼ä¸Šè‹±æ–‡æ–‡ç« ..."></textarea>
        <button onclick="submitPaste()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl">ğŸš€ é–‹å§‹åˆ†æ</button>
      </div>
      <p id="loading-msg" class="hidden mt-6 text-center text-indigo-600 animate-pulse">ğŸ¤– AI æ­£åœ¨åˆæˆä¸­ (é€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“)...</p>
    </div>
  </div>

  <div id="view-cards" class="hidden w-full max-w-lg p-4 h-full flex-col justify-center">
    <div class="flex justify-between items-center mb-4">
      <button onclick="goBackToMenu()" class="bg-white px-3 py-1.5 rounded-lg shadow-sm text-sm">ğŸ  é¦–é </button>
      <span id="counter" class="text-indigo-600 font-bold">1 / 10</span>
    </div>
    <div class="relative w-full h-[60vh] perspective-1000 group cursor-pointer" onclick="flipCard(this)">
      <div class="content-box relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl">
        <div class="absolute w-full h-full bg-white rounded-3xl p-8 flex flex-col backface-hidden border">
          <div class="flex-grow flex items-center justify-center">
            <h2 id="card-eng" class="text-2xl leading-relaxed text-gray-800 font-eng text-left">...</h2>
          </div>
          <p class="text-center text-gray-300 text-xs uppercase">Tap to flip</p>
        </div>
        <div class="absolute w-full h-full bg-slate-800 rounded-3xl p-8 flex flex-col backface-hidden rotate-y-180 text-white">
          <div class="flex-grow overflow-y-auto custom-scroll">
            <p id="card-chn" class="text-xl leading-relaxed font-chn text-slate-100">...</p>
          </div>
          <div class="mt-4 flex gap-3">
            <button onclick="speakTarget(event)" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold">ğŸ”Š æœ—è®€</button>
          </div>
        </div>
      </div>
    </div>
    <div class="flex justify-between mt-6 gap-4">
      <button onclick="prevCard()" class="flex-1 bg-white text-gray-700 py-4 rounded-xl font-bold shadow">â† ä¸Šä¸€å¼µ</button>
      <button onclick="nextCard()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg">ä¸‹ä¸€å¼µ â†’</button>
    </div>
  </div>

  <div id="view-review" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[85vh] flex flex-col relative border">
      <div class="flex justify-between items-center mb-4 border-b pb-4">
        <h2 class="text-xl font-bold">ğŸ“– å…¨æ–‡é–±è®€</h2>
        <button id="btn-save-article" onclick="saveCurrentArticle()" class="text-indigo-600 font-bold">ğŸ’¾ å„²å­˜</button>
      </div>
      <div class="flex-grow overflow-y-auto custom-scroll pr-2 relative">
        <h3 id="review-title" class="text-2xl font-bold text-indigo-700 mb-4">Title</h3>
        <div id="review-content" class="prose text-gray-800 font-eng text-lg leading-loose"></div>
        <hr class="my-8">
        <div id="review-content-chn" class="text-gray-500 font-chn text-base leading-relaxed"></div>

        <div id="word-popup">
            <div class="flex justify-between items-start">
                <h4 id="popup-word" class="text-lg font-bold text-indigo-700">Word</h4>
                <button onclick="closePopup()">Ã—</button>
            </div>
            <p id="popup-ipa" class="text-xs text-gray-400 font-mono">/ipa/</p>
            <p id="popup-def" class="text-sm text-gray-700 font-chn mt-2">Loading...</p>
            <button id="btn-popup-save" onclick="savePopupWord()" class="mt-3 w-full bg-indigo-600 text-white text-xs py-1.5 rounded">+ ç”Ÿå­—æœ¬</button>
        </div>
      </div>
      <div class="mt-4 pt-4 border-t flex gap-3">
        <button id="btn-read-all" onclick="playFullArticle()" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">ğŸ”Š å…¨æ–‡æœ—è®€</button>
        <button onclick="goBackToMenu()" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-600">ğŸ  é¦–é </button>
      </div>
    </div>
  </div>

  <script>
    // ğŸ”¥ é‡è¦ï¼šè«‹å¡«å…¥æ‚¨æœ€æ–°çš„ GAS éƒ¨ç½²ç¶²å€
    const API_URL = "https://script.google.com/macros/s/AKfycbzTciZ2Z7Xrmc8IrV-VHqmJMT6rdbnnIbnE1j6YYKDv3yC3Av0fvofThL6pBmvj_GP0MQ/exec";

    let currentCards = [], currentIndex = 0, isPlayingFull = false;
    let currentArticleText = "", currentArticleChinese = "", currentArticleTitle = "";
    let currentUserId = "", voices = [];

    // --- ğŸ™ï¸ æ ¸å¿ƒï¼šAI å—“éŸ³ + å‚™æ´æ¨¡å¼ ---
    async function speak(txt, version = 'A_Professional') {
        if (!txt) return;
        
        // 1. åœæ­¢èˆŠéŸ³è¨Š
        window.speechSynthesis.cancel();
        const oldAudio = document.getElementById('ai-audio-player');
        if (oldAudio) oldAudio.pause();

        try {
            // 2. è«‹æ±‚ AI å—“å­ç¶²å€
            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: 'tts', text: txt, version: version })
            });
            const json = await res.json();

            if (json.status === 'success' && json.audioUrl) {
                let player = document.getElementById('ai-audio-player');
                if (!player) {
                    player = document.createElement('audio');
                    player.id = 'ai-audio-player';
                    document.body.appendChild(player);
                }
                player.src = json.audioUrl;
                player.play();
                console.log("ğŸ”Š æ­£åœ¨æ’­æ”¾ AI æ¨¡æ“¬æ’­éŸ³å“¡è²éŸ³...");
            } else { throw new Error("TTS Failed"); }
        } catch (e) {
            console.warn("âš ï¸ AI èªéŸ³æš«ä¸å¯ç”¨ï¼Œåˆ‡æ›å‚™æ´èªéŸ³:", e.message);
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'en-US';
            u.rate = 0.9;
            const vIdx = document.getElementById('input-voice').value;
            if (voices[vIdx]) u.voice = voices[vIdx];
            window.speechSynthesis.speak(u);
        }
    }

    // --- å…¨æ–‡æœ—è®€ ---
    function playFullArticle() {
        if(isPlayingFull){ 
            window.speechSynthesis.cancel();
            const p = document.getElementById('ai-audio-player');
            if(p) p.pause();
            isPlayingFull = false;
            document.getElementById('btn-read-all').innerText = 'ğŸ”Š å…¨æ–‡æœ—è®€';
            return; 
        }
        isPlayingFull = true; 
        document.getElementById('btn-read-all').innerText = 'ğŸ›‘ åœæ­¢'; 
        speak(currentArticleTitle + ". " + currentArticleText, 'B_Philosophical');
    }

    // --- åˆå§‹åŒ– ---
    function init() {
        const saved = localStorage.getItem('gem_username');
        if (saved) {
            currentUserId = saved;
            document.getElementById('display-user').innerText = currentUserId;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-input').classList.remove('hidden');
        }
        loadVoices();
    }

    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
        const select = document.getElementById('input-voice');
        select.innerHTML = '';
        voices.filter(v => v.lang.startsWith('en')).forEach((v, i) => {
            const opt = document.createElement('option');
            opt.value = voices.indexOf(v);
            opt.text = v.name;
            select.appendChild(opt);
        });
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    // --- ç™»å…¥é‚è¼¯ ---
    function handleLogin() {
        const name = document.getElementById('login-username').value.trim();
        if (!name) return alert("è«‹è¼¸å…¥å§“å");
        currentUserId = name;
        localStorage.setItem('gem_username', name);
        document.getElementById('display-user').innerText = name;
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-input').classList.remove('hidden');
    }

    function handleLogout() {
        localStorage.removeItem('gem_username');
        location.reload();
    }

    // --- API å‘¼å« ---
    async function callApi(action, params) {
        try {
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, ...params }) });
            const json = await res.json();
            if (json.status === 'error') throw new Error(json.message);
            return json;
        } catch (e) { alert(e.message); throw e; }
    }

    // --- å­¸ç¿’æµç¨‹ ---
    function switchTab(mode) {
        document.getElementById('form-topic').classList.toggle('hidden', mode!=='topic');
        document.getElementById('form-paste').classList.toggle('hidden', mode!=='paste');
    }

    function submitTopic() {
        const t = document.getElementById('input-topic').value;
        if(!t) return alert("è«‹è¼¸å…¥ä¸»é¡Œ");
        startGen('generate', { topic: t, level: document.getElementById('input-level').value, len: 'medium', scenario: document.getElementById('input-scenario').value });
    }

    function submitPaste() {
        const c = document.getElementById('input-content').value;
        const t = document.getElementById('input-title').value;
        if(!c) return alert("è«‹è²¼ä¸Šæ–‡ç« ");
        startGen('import', { title: t, content: c, len: 'medium' });
    }

    function startGen(act, data) {
        document.getElementById('loading-msg').classList.remove('hidden');
        callApi(act, data).then(res => {
            document.getElementById('loading-msg').classList.add('hidden');
            currentCards = res.data.cards; currentIndex = 0;
            currentArticleText = currentCards.map(c => c.english).join(' ');
            currentArticleChinese = currentCards.map(c => c.chinese).join('<br><br>');
            currentArticleTitle = res.data.title || 'New Lesson';
            
            document.getElementById('view-input').classList.add('hidden');
            document.getElementById('view-cards').classList.remove('hidden');
            document.getElementById('view-cards').classList.add('flex');
            renderCard();
        });
    }

    function renderCard() {
        const c = currentCards[currentIndex];
        document.getElementById('card-eng').innerText = c.english;
        document.getElementById('card-chn').innerText = c.chinese;
        document.getElementById('counter').innerText = `${currentIndex+1}/${currentCards.length}`;
        document.querySelector('.content-box').parentElement.classList.remove('flipped');
    }

    function flipCard(el) { el.classList.toggle('flipped'); }
    function nextCard() { if(currentIndex < currentCards.length-1){ currentIndex++; renderCard(); } else { showReviewPage(); } }
    function prevCard() { if(currentIndex > 0){ currentIndex--; renderCard(); } }
    function speakTarget(e) { e.stopPropagation(); speak(currentCards[currentIndex].english); }

    function showReviewPage() {
        document.getElementById('view-cards').classList.add('hidden');
        document.getElementById('view-review').classList.remove('hidden');
        document.getElementById('view-review').classList.add('flex');
        document.getElementById('review-title').innerText = currentArticleTitle;
        const contentDiv = document.getElementById('review-content');
        contentDiv.innerHTML = currentArticleText.split(/(\s+)/).map(w => {
            if(w.trim().length === 0) return w;
            const raw = w.replace(/[^\w']/g, "");
            return `<span class="clickable-word" onclick="handleWordClick('${raw}', this)">${w}</span>`;
        }).join('');
        document.getElementById('review-content-chn').innerHTML = currentArticleChinese;
    }

    async function handleWordClick(word, el) {
        if(!isPlayingFull) speak(word);
        const popup = document.getElementById('word-popup');
        const rect = el.getBoundingClientRect();
        popup.style.top = `${rect.top + window.scrollY - 80}px`;
        popup.style.left = `${rect.left}px`;
        popup.style.display = 'block';
        document.getElementById('popup-word').innerText = word;
        document.getElementById('popup-def').innerText = "Translating...";
        
        callApi('translate', { word: word, context: currentArticleText.substring(0, 200) }).then(res => {
            document.getElementById('popup-ipa').innerText = res.data.ipa;
            document.getElementById('popup-def').innerText = res.data.def;
            window.currentWord = res.data;
        });
    }

    function closePopup() { document.getElementById('word-popup').style.display = 'none'; }

    function savePopupWord() {
        if(!window.currentWord) return;
        callApi('saveVocab', { userId: currentUserId, ...window.currentWord, ctx: currentArticleText.substring(0, 100) }).then(() => {
            alert("å·²åŠ å…¥ç”Ÿå­—æœ¬");
            closePopup();
        });
    }

    function goBackToMenu() {
        stopFullAudio();
        document.querySelectorAll('.flex-col').forEach(el => el.classList.add('hidden'));
        document.getElementById('view-input').classList.remove('hidden');
    }

    init();
  </script>
</body>
</html>
