// ğŸ”¥ å‰ç«¯ API åœ°å€ (è«‹ç¢ºä¿å¡«å…¥æœ€æ–°çš„éƒ¨ç½²ç¶²å€)
const API_URL = "https://script.google.com/macros/s/AKfycbzTciZ2Z7Xrmc8IrV-VHqmJMT6rdbnnIbnE1j6YYKDv3yC3Av0fvofThL6pBmvj_GP0MQ/exec";

let currentCards = [], currentIndex = 0, isPlayingFull = false;
let currentArticleText = "", currentArticleChinese = "", currentArticleTitle = "";
let currentUserId = "", voices = [];

// --- ğŸ™ï¸ èªéŸ³åˆæˆï¼šAI å„ªå…ˆ + ç€è¦½å™¨å‚™æ´ ---
async function speak(txt, version = 'A_Professional') {
    if (!txt) return;
    window.speechSynthesis.cancel();
    const oldAudio = document.getElementById('ai-audio-player');
    if (oldAudio) oldAudio.pause();

    try {
        // è«‹æ±‚ AI å—“å­ç¶²å€
        const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify({ action: 'tts', text: txt, version: version })
        });
        const json = await res.json();

        if (json.status === 'success' && json.audioUrl) {
            let player = document.getElementById('ai-audio-player') || document.createElement('audio');
            player.id = 'ai-audio-player';
            if (!player.parentElement) document.body.appendChild(player);
            player.src = json.audioUrl;
            player.play();
        } else { throw new Error("AI TTS è¿”å›ç„¡æ•ˆ"); }
    } catch (e) {
        console.warn("âš ï¸ AI èªéŸ³å¤±æ•ˆï¼Œåˆ‡æ›å‚™æ´:", e.message);
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-US'; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }
}

// --- ğŸ› ï¸ é‡è¦ï¼šä¿®æ­£åŸæœ¬ ReferenceError çš„å‘¼å«é» ---
function submitTopic() {
    const t = document.getElementById('input-topic').value;
    if(!t) return alert("è«‹è¼¸å…¥ä¸»é¡Œ");
    // ä¿®æ­£ï¼šå¿…é ˆå‘¼å« startGen è€Œä¸æ˜¯ handleTopicGeneration
    startGen('generate', { 
        topic: t, 
        level: document.getElementById('input-level').value, 
        len: 'medium', 
        scenario: document.getElementById('input-scenario').value 
    });
}

function startGen(act, data) {
    document.getElementById('loading-msg').classList.remove('hidden');
    callApi(act, data).then(res => {
        document.getElementById('loading-msg').classList.add('hidden');
        currentCards = res.data.cards; currentIndex = 0;
        currentArticleText = currentCards.map(c => c.english).join(' ');
        currentArticleChinese = currentCards.map(c => c.chinese).join('<br><br>');
        currentArticleTitle = res.data.title || 'Lesson';
        
        document.getElementById('view-input').classList.add('hidden');
        document.getElementById('view-cards').classList.remove('hidden');
        document.getElementById('view-cards').classList.add('flex');
        renderCard(); // æ¸²æŸ“ç¬¬ä¸€å¼µå¡ç‰‡
    });
}

function renderCard() {
    const c = currentCards[currentIndex];
    document.getElementById('card-eng').innerText = c.english;
    document.getElementById('card-chn').innerText = c.chinese;
    document.getElementById('counter').innerText = `${currentIndex+1} / ${currentCards.length}`;
    document.querySelector('.content-box').parentElement.classList.remove('flipped');
}

// ...å…¶é¤˜ callApi, handleLogin, nextCard, prevCard å‡½å¼è«‹ä¿ç•™åŸç‹€...
