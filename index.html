<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GemArticle - AI Tutor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    /* å­—é«”èˆ‡åŸºç¤è¨­å®š */
    .font-eng { font-family: 'Merriweather', serif; }
    .font-chn { font-family: 'Noto Sans TC', sans-serif; }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
    
    .perspective-1000 { perspective: 1000px; }
    .transform-style-3d { transform-style: preserve-3d; }
    .backface-hidden { backface-visibility: hidden; }
    .rotate-y-180 { transform: rotateY(180deg); }
    .group.flipped .content-box { transform: rotateY(180deg); }

    .clickable-word {
        cursor: pointer; padding: 2px 0; border-radius: 4px; transition: background-color 0.2s, color 0.2s;
    }
    .clickable-word:hover {
        background-color: #e0e7ff; color: #4338ca; text-decoration: underline;
    }
    
    #word-popup {
        position: absolute; z-index: 50; background: white; border-radius: 12px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb; padding: 12px; min-width: 220px; max-width: 300px; display: none;
        animation: popup-fade 0.2s ease-out;
    }
    @keyframes popup-fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #word-popup::after {
        content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%) rotate(45deg);
        width: 12px; height: 12px; background: white; border-bottom: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col items-center justify-center font-sans">

  <div id="view-login" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex flex-col items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
        <h1 class="text-2xl font-bold text-indigo-700 mb-2">ğŸ‘‹ æ­¡è¿å›ä¾†</h1>
        <p class="text-gray-500 text-sm mb-6">è«‹è¼¸å…¥å§“åä»¥åŒæ­¥æ‚¨çš„å­¸ç¿’è³‡æ–™</p>
        <input type="text" id="login-username" class="w-full px-4 py-3 border border-gray-300 rounded-xl mb-4 text-center text-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ä¾‹å¦‚: Jason99">
        <button onclick="handleLogin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">ğŸš€ é€²å…¥ç³»çµ± (Login)</button>
        <p class="text-xs text-gray-400 mt-4">* æ‰‹æ©Ÿèˆ‡é›»è…¦è¼¸å…¥ç›¸åŒåç¨±å³å¯å…±ç”¨è³‡æ–™</p>
    </div>
  </div>

  <div id="view-input" class="hidden w-full max-w-lg p-6 transition-all duration-300">
    <div class="bg-white rounded-2xl shadow-xl p-8 relative">
      <div class="absolute top-4 right-4 flex gap-2">
        <button onclick="openLibrary()" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition" title="æˆ‘çš„æ–‡ç« åº«"><span class="text-xl">ğŸ“‚</span></button>
        <button onclick="openWordBank()" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-full transition" title="æˆ‘çš„ç”Ÿå­—æœ¬"><span class="text-xl">ğŸ“š</span></button>
      </div>
      <div class="absolute top-4 left-4 flex gap-2 items-center">
        <span id="display-user" class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">Guest</span>
        <button onclick="handleLogout()" class="text-xs text-red-400 hover:underline">ç™»å‡º</button>
      </div>

      <div class="flex justify-center mt-6 mb-6 border-b border-gray-200">
        <button onclick="switchTab('topic')" id="tab-topic" class="border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2">âœ¨ AI ç”Ÿæˆ</button>
        <button onclick="switchTab('paste')" id="tab-paste" class="text-gray-500 px-6 py-2">ğŸ“‹ è²¼ä¸Šæ–‡ç« </button>
      </div>

      <div class="mb-6 bg-gray-50 p-3 rounded-xl border border-gray-200">
         <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ğŸ—£ï¸ æœ—è®€è¨­å®š (Voice Settings)</label>
         <select id="input-voice" class="w-full bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm outline-none mb-3"></select>
         
         <div class="flex justify-between items-center mb-1">
             <label class="text-xs font-bold text-gray-400 uppercase">âš¡ é€Ÿåº¦ (Speed): <span id="speed-val" class="text-indigo-600">1.0</span>x</label>
         </div>
         <input type="range" id="input-rate" min="0.5" max="2" step="0.1" value="1" class="w-full accent-indigo-600 cursor-pointer mb-3">

         <div class="flex justify-between items-center mb-1">
             <label class="text-xs font-bold text-gray-400 uppercase">ğŸµ éŸ³èª¿ (Pitch): <span id="pitch-val" class="text-indigo-600">1.0</span></label>
         </div>
         <div class="flex items-center gap-2">
             <span class="text-xs text-gray-400">ä½æ²‰</span>
             <input type="range" id="input-pitch" min="0.5" max="1.5" step="0.1" value="1" class="w-full accent-indigo-600 cursor-pointer">
             <span class="text-xs text-gray-400">é«˜äº¢</span>
         </div>
      </div>

      <div id="form-topic" class="block">
        <input type="text" id="input-topic" class="w-full mb-4 px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="è¼¸å…¥ä¸»é¡Œ (Topic) - e.g., æ—…éŠ, AI...">
        <div class="grid grid-cols-2 gap-4 mb-4">
          <select id="input-scenario" class="px-3 py-3 border rounded-xl bg-white text-sm text-indigo-700 font-semibold">
            <option value="article">ğŸ“˜ çŸ­æ–‡ (Article)</option>
            <option value="conversation">ğŸ’¬ å°è©± (Dialogue)</option>
            <option value="news">ğŸ“° æ–°è (News Search)</option>
          </select>
          <select id="input-len-topic" class="px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="medium">æ¨™æº–é•·åº¦ (Standard)</option>
            <option value="short">çŸ­ç¯‡ (Short)</option>
          </select>
        </div>
        <select id="input-level" class="w-full mb-6 px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="elementary">åˆç´š (Elementary)</option>
            <option value="high" selected>é«˜ä¸­ (High School)</option>
            <option value="adult">å°ˆæ¥­ (Professional)</option>
        </select>
        <button onclick="submitTopic()" id="btn-topic" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition">âœ¨ é–‹å§‹å­¸ç¿’ (Start Learning)</button>
      </div>

      <div id="form-paste" class="hidden">
        <input type="text" id="input-title" class="w-full mb-3 px-4 py-3 border rounded-xl outline-none" placeholder="æ–‡ç« æ¨™é¡Œ (Title)">
        <textarea id="input-content" rows="4" class="w-full mb-4 px-4 py-3 border rounded-xl outline-none" placeholder="åœ¨æ­¤è²¼ä¸Šè‹±æ–‡æ–‡ç«  (Paste English text)..."></textarea>
        <select id="input-len-paste" class="w-full mb-4 px-3 py-3 border rounded-xl bg-white text-sm">
            <option value="medium">æ¨™æº–åˆ†æ®µ (Standard)</option>
        </select>
        <button onclick="submitPaste()" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg transition">ğŸš€ é–‹å§‹åˆ†æ (Analyze)</button>
      </div>
      <p id="loading-msg" class="hidden mt-6 text-center text-indigo-600 text-sm font-semibold animate-pulse">ğŸ¤– AI æ­£åœ¨æ’°å¯«ä¸­ (AI is writing)...</p>
    </div>
  </div>

  <div id="view-cards" class="hidden w-full max-w-lg p-4 h-full flex-col justify-center">
    <div class="flex justify-between items-center mb-4 px-2">
      <button onclick="goBackToMenu()" class="text-gray-500 hover:text-indigo-600 font-bold text-sm bg-white px-3 py-1.5 rounded-lg shadow-sm">ğŸ  é¦–é  (Home)</button>
      <div class="text-center"><h2 id="card-main-title" class="text-xs font-bold text-gray-400 uppercase truncate max-w-[150px]">Lesson</h2><span id="counter" class="font-mono text-indigo-600 font-bold text-sm">1 / 10</span></div>
    </div>
    <div class="relative w-full h-[70vh] perspective-1000 group cursor-pointer" onclick="flipCard(this)">
      <div class="content-box relative w-full h-full transition-all duration-500 transform-style-3d shadow-2xl rounded-3xl">
        <div class="absolute w-full h-full bg-white rounded-3xl p-6 flex flex-col backface-hidden border border-gray-100">
          <div class="flex-grow overflow-y-auto custom-scroll flex flex-col justify-center">
            <h2 id="card-eng" class="text-2xl leading-relaxed text-gray-800 font-eng text-left">...</h2>
          </div>
          <p class="mt-2 text-center text-gray-300 text-xs uppercase animate-pulse">Tap to check</p>
        </div>
        <div class="absolute w-full h-full bg-slate-800 rounded-3xl p-6 flex flex-col justify-between backface-hidden rotate-y-180 text-white">
          <div class="flex-grow overflow-y-auto custom-scroll pt-4">
            <p id="card-chn" class="text-xl leading-relaxed font-chn text-slate-100 mb-6">...</p>
            <div id="vocab-area" class="border-t border-slate-600 pt-4 hidden"><div id="vocab-list" class="flex flex-wrap gap-2"></div></div>
          </div>
          <div class="mt-2 pt-3 border-t border-slate-600 flex gap-3">
            <button onclick="speakTarget(event)" class="flex-1 bg-white/10 hover:bg-white/20 py-3 rounded-xl font-bold text-sm">ğŸ”Š æœ—è®€ (Listen)</button>
            <button id="btn-mic" onclick="toggleRecording(event)" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-3 rounded-xl font-bold">ğŸ¤ è·Ÿè®€ (Speak)</button>
          </div>
        </div>
      </div>
    </div>
    <div class="flex justify-between mt-6 gap-4">
      <button onclick="prevCard()" class="flex-1 bg-white text-gray-700 py-3 rounded-xl font-bold shadow">â† ä¸Šä¸€å¼µ</button>
      <button onclick="nextCard()" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg">ä¸‹ä¸€å¼µ â†’</button>
    </div>
  </div>

  <div id="view-review" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center relative">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[85vh] flex flex-col relative border border-gray-100">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 font-eng">ğŸ“– å…¨æ–‡é–±è®€ (Full Article)</h2>
        <div class="flex gap-2">
            <button id="btn-save-article" onclick="saveCurrentArticle()" class="text-indigo-600 hover:bg-indigo-50 p-1.5 rounded transition font-bold text-sm">ğŸ’¾ å„²å­˜ (Save)</button>
            <button onclick="goBackToMenu()" class="text-gray-400 font-bold text-sm">âœ•</button>
        </div>
      </div>
      
      <div class="flex-grow overflow-y-auto custom-scroll relative pr-2">
         <div id="english-area">
             <h3 id="review-title" class="text-2xl font-bold text-indigo-700 mb-4 font-eng clickable-word" onclick="speak(this.innerText)">Title</h3>
             <div id="review-content" class="prose text-gray-800 font-eng text-lg leading-loose mb-6"></div>
         </div>
         <hr class="border-t-4 border-indigo-100 my-8 rounded-full">
         <div id="chinese-area">
             <h3 class="text-sm font-bold text-gray-400 mb-3 font-chn bg-gray-100 inline-block px-2 py-1 rounded">ğŸ’¡ ä¸­æ–‡ç¿»è­¯ (Reference)</h3>
             <div id="review-content-chn" class="prose text-gray-500 font-chn text-base leading-relaxed">(ç¿»è­¯è¼‰å…¥ä¸­...)</div>
         </div>

         <div id="word-popup">
            <div class="flex justify-between items-start mb-1">
                <h4 id="popup-word" class="text-lg font-bold text-indigo-700">Word</h4>
                <button onclick="closePopup()" class="text-gray-300 hover:text-gray-500">Ã—</button>
            </div>
            <div class="flex items-center gap-2 mb-2">
                <span id="popup-ipa" class="text-xs text-gray-500 font-mono">/ipa/</span>
                <button onclick="playPopupAudio()" class="text-indigo-500 text-xs hover:bg-indigo-50 rounded px-1">ğŸ”Š</button>
            </div>
            <p id="popup-def" class="text-sm text-gray-700 font-chn leading-snug">Loading definition...</p>
            <button id="btn-popup-save" onclick="savePopupWord()" class="mt-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xs py-1.5 rounded transition">+ åŠ å…¥ç”Ÿå­—æœ¬ (Save)</button>
         </div>
      </div>

      <div class="mt-4 pt-4 border-t border-gray-100">
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="bg-gray-50 px-2 py-2 rounded-xl border border-gray-200">
                 <label class="text-xs font-bold text-gray-500 uppercase block mb-1">âš¡ é€Ÿåº¦: <span id="speed-val-review" class="text-indigo-600">1.0</span>x</label>
                 <input type="range" id="input-rate-review" min="0.5" max="2" step="0.1" value="1" class="w-full accent-indigo-600 cursor-pointer h-1">
            </div>
            <div class="bg-gray-50 px-2 py-2 rounded-xl border border-gray-200">
                 <label class="text-xs font-bold text-gray-500 uppercase block mb-1">ğŸµ éŸ³èª¿: <span id="pitch-val-review" class="text-indigo-600">1.0</span></label>
                 <input type="range" id="input-pitch-review" min="0.5" max="1.5" step="0.1" value="1" class="w-full accent-indigo-600 cursor-pointer h-1">
            </div>
        </div>

        <div class="flex gap-3">
            <button id="btn-read-all" onclick="playFullArticle()" class="flex-1 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">ğŸ”Š å…¨æ–‡æœ—è®€ (è‹±æ–‡)</button>
            <button onclick="goBackToMenu()" class="flex-1 bg-gray-100 text-gray-600 py-3 rounded-xl font-bold">ğŸ  å›é¦–é </button>
        </div>
      </div>
    </div>
  </div>

  <div id="view-wordbank" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[80vh] flex flex-col border border-gray-100">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 font-chn">ğŸ“š æˆ‘çš„ç”Ÿå­—æœ¬</h2>
        <button onclick="goBackToMenu()" class="text-gray-400 text-sm">âœ•</button>
      </div>
      <div id="wordbank-list" class="flex-grow overflow-y-auto custom-scroll space-y-3"><p class="text-center text-gray-400 mt-10">Loading...</p></div>
      <button onclick="loadWordBank()" class="mt-4 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">â†» é‡æ–°æ•´ç† (Refresh)</button>
    </div>
  </div>

  <div id="view-library" class="hidden w-full max-w-lg p-6 h-full flex-col justify-center">
    <div class="bg-white rounded-3xl shadow-2xl p-6 h-[80vh] flex flex-col border border-gray-100">
      <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
        <h2 class="text-xl font-bold text-gray-800 font-chn">ğŸ“‚ æˆ‘çš„æ–‡ç« åº«</h2>
        <button onclick="goBackToMenu()" class="text-gray-400 text-sm">âœ•</button>
      </div>
      <div id="library-list" class="flex-grow overflow-y-auto custom-scroll space-y-3"><p class="text-center text-gray-400 mt-10">Loading...</p></div>
      <button onclick="loadLibrary()" class="mt-4 bg-indigo-50 text-indigo-600 py-3 rounded-xl font-bold">â†» é‡æ–°æ•´ç† (Refresh)</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzTciZ2Z7Xrmc8IrV-VHqmJMT6rdbnnIbnE1j6YYKDv3yC3Av0fvofThL6pBmvj_GP0MQ/exec"; 

    let currentCards = [], currentIndex = 0, isPlayingFull = false, recognition, isRecording = false;
    let voices = [], wordCache = {}; 
    let currentPopupData = null;
    let currentArticleText = "";
    let currentArticleChinese = "";
    let currentArticleTitle = "";
    let currentUserId = ""; 
    let utteranceQueue = [];

    function init() {
        const savedUser = localStorage.getItem('gem_username');
        if (savedUser) {
            currentUserId = savedUser;
            document.getElementById('display-user').innerText = currentUserId;
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-input').classList.remove('hidden');
        } else {
            document.getElementById('view-login').classList.remove('hidden');
        }
        loadVoices();
    }

    function handleLogin() {
        const nameInput = document.getElementById('login-username').value.trim();
        if (!nameInput) return alert("è«‹è¼¸å…¥å§“å");
        currentUserId = nameInput;
        localStorage.setItem('gem_username', currentUserId); 
        document.getElementById('display-user').innerText = currentUserId;
        document.getElementById('view-login').classList.add('hidden');
        document.getElementById('view-input').classList.remove('hidden');
    }

    function handleLogout() {
        localStorage.removeItem('gem_username');
        currentUserId = "";
        location.reload(); 
    }

    function getUserId() {
        if (!currentUserId) {
            document.getElementById('view-input').classList.add('hidden');
            document.getElementById('view-login').classList.remove('hidden');
            throw new Error("è«‹å…ˆç™»å…¥");
        }
        return currentUserId;
    }

    function loadVoices() {
      voices = window.speechSynthesis.getVoices();
      const select = document.getElementById('input-voice');
      select.innerHTML = '';
      const engVoices = voices.filter(v => v.lang.startsWith('en'));
      const listToShow = engVoices.length > 0 ? engVoices : voices;
      
      listToShow.forEach((v) => {
          const option = document.createElement('option');
          option.value = voices.indexOf(v);
          option.text = `${v.name} (${v.lang})`;
          select.appendChild(option);
      });
      let defaultIdx = voices.findIndex(v => v.name.includes('Google US English'));
      if (defaultIdx === -1) defaultIdx = voices.findIndex(v => v.name.includes('Microsoft Aria'));
      if (defaultIdx === -1) defaultIdx = voices.findIndex(v => v.lang === 'en-US');
      if (defaultIdx !== -1) select.value = defaultIdx;
      else if (engVoices.length > 0) select.value = voices.indexOf(engVoices[0]);
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;

    // ç›£è½å™¨ï¼šé€Ÿåº¦èˆ‡éŸ³èª¿
    function syncSettings(sourceRateId, sourcePitchId, targetRateId, targetPitchId) {
        const rate = document.getElementById(sourceRateId).value;
        const pitch = document.getElementById(sourcePitchId).value;
        
        // æ›´æ–°æ•¸å€¼é¡¯ç¤º
        if(document.getElementById('speed-val')) document.getElementById('speed-val').innerText = rate;
        if(document.getElementById('speed-val-review')) document.getElementById('speed-val-review').innerText = rate;
        if(document.getElementById('pitch-val')) document.getElementById('pitch-val').innerText = pitch;
        if(document.getElementById('pitch-val-review')) document.getElementById('pitch-val-review').innerText = pitch;

        // åŒæ­¥å¦ä¸€å€‹è¦–åœ–çš„æ»‘æ¡¿
        if(document.getElementById(targetRateId)) document.getElementById(targetRateId).value = rate;
        if(document.getElementById(targetPitchId)) document.getElementById(targetPitchId).value = pitch;
    }

    document.getElementById('input-rate').addEventListener('input', () => syncSettings('input-rate', 'input-pitch', 'input-rate-review', 'input-pitch-review'));
    document.getElementById('input-pitch').addEventListener('input', () => syncSettings('input-rate', 'input-pitch', 'input-rate-review', 'input-pitch-review'));
    document.getElementById('input-rate-review').addEventListener('input', () => syncSettings('input-rate-review', 'input-pitch-review', 'input-rate', 'input-pitch'));
    document.getElementById('input-pitch-review').addEventListener('input', () => syncSettings('input-rate-review', 'input-pitch-review', 'input-rate', 'input-pitch'));


    // Speak Function (å«éŸ³èª¿æ§åˆ¶)
    function speak(txt){ 
        if(!isPlayingFull) window.speechSynthesis.cancel(); 
        
        const u = new SpeechSynthesisUtterance(txt); 
        u.lang = 'en-US'; 
        
        // è®€å–è¨­å®š (å…©å€‹ä»‹é¢å·²åŒæ­¥ï¼Œè®€å…¶ä¸­ä¸€å€‹å³å¯)
        u.rate = parseFloat(document.getElementById('input-rate').value) || 1;
        u.pitch = parseFloat(document.getElementById('input-pitch').value) || 1;

        const voiceIdx = document.getElementById('input-voice').value;
        const v = voices[voiceIdx]; 
        if(v) u.voice = v; 
        window.speechSynthesis.speak(u); 
    }

    async function callApi(action, params) {
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action, ...params }) });
        const json = await res.json();
        if (json.status === 'error') throw new Error(json.message);
        return json;
      } catch (e) { alert("Error: " + e.message); throw e; }
    }

    function goBackToMenu() {
      stopFullAudio();
      ['view-cards', 'view-review', 'view-wordbank', 'view-library'].forEach(id => {
          document.getElementById(id).classList.remove('flex');
          document.getElementById(id).classList.add('hidden');
      });
      document.getElementById('view-input').classList.remove('hidden');
    }
    
    function switchTab(mode) {
       document.getElementById('form-topic').classList.toggle('hidden', mode!=='topic');
       document.getElementById('form-paste').classList.toggle('hidden', mode!=='paste');
       document.getElementById('tab-topic').className = mode==='topic'?'border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2':'text-gray-500 px-6 py-2';
       document.getElementById('tab-paste').className = mode==='paste'?'border-b-2 border-indigo-600 text-indigo-600 font-bold px-6 py-2':'text-gray-500 px-6 py-2';
    }

    function submitTopic() {
       const topic=document.getElementById('input-topic').value; if(!topic)return alert("è«‹è¼¸å…¥ä¸»é¡Œ");
       startGen('generate', { topic, level:document.getElementById('input-level').value, len:document.getElementById('input-len-topic').value, scenario:document.getElementById('input-scenario').value });
    }
    function submitPaste() {
       const txt=document.getElementById('input-content').value; if(!txt)return alert("è«‹è²¼ä¸Šæ–‡ç« ");
       const title = document.getElementById('input-title').value; 
       startGen('import', { title: title, content:txt, len:document.getElementById('input-len-paste').value });
    }
    function startGen(act, data) {
        document.getElementById('loading-msg').classList.remove('hidden');
        callApi(act, data).then(res => {
            document.getElementById('loading-msg').classList.add('hidden');
            currentCards = res.data.cards; currentIndex = 0;
            currentArticleText = currentCards.map(c => c.english).join(' ');
            currentArticleChinese = currentCards.map(c => c.chinese).join('<br><br>');
            currentArticleTitle = res.data.title || 'Lesson'; 
            
            document.getElementById('card-main-title').innerText = currentArticleTitle;
            document.getElementById('view-input').classList.add('hidden');
            document.getElementById('view-cards').classList.remove('hidden');
            document.getElementById('view-cards').classList.add('flex');
            renderCard();
        });
    }

    function renderCard() {
        const c = currentCards[currentIndex];
        document.getElementById('card-eng').innerText = c.english;
        document.getElementById('card-chn').innerText = c.chinese;
        document.getElementById('counter').innerText = `${currentIndex+1}/${currentCards.length}`;
        const vList = document.getElementById('vocab-list');
        if(c.vocabulary && c.vocabulary.length){
            document.getElementById('vocab-area').classList.remove('hidden');
            vList.innerHTML = c.vocabulary.map(v => `<button onclick="event.stopPropagation();saveWord('${v.word}','${v.ipa}','${v.def}', '${escape(c.english)}', '${escape(c.chinese)}', this)" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs rounded-full">+ ${v.word}</button>`).join('');
        } else { document.getElementById('vocab-area').classList.add('hidden'); }
        document.querySelector('.group').classList.remove('flipped');
    }
    function flipCard(el){ if(!isRecording) el.classList.toggle('flipped'); }
    function nextCard(){ if(currentIndex<currentCards.length-1){currentIndex++; renderCard();} else { showReviewPage(false); } }
    function prevCard(){ if(currentIndex>0){currentIndex--; renderCard();} }
    function speakTarget(e){ e.stopPropagation(); speak(currentCards[currentIndex].english); }

    function showReviewPage(isFromLibrary = false) {
        document.getElementById('view-cards').classList.add('hidden');
        document.getElementById('view-cards').classList.remove('flex');
        const view = document.getElementById('view-review');
        view.classList.remove('hidden'); view.classList.add('flex');
        
        // ç¢ºä¿é€²å…¥é–±è®€æ¨¡å¼æ™‚ï¼Œæ»‘æ¡¿ç‹€æ…‹æ˜¯åŒæ­¥çš„
        syncSettings('input-rate', 'input-pitch', 'input-rate-review', 'input-pitch-review');

        const saveBtn = document.getElementById('btn-save-article');
        if(isFromLibrary) {
            saveBtn.innerHTML = "ğŸ“‚ å·²æ”¶è— (Saved)"; saveBtn.disabled = true; saveBtn.classList.add('text-gray-400');
        } else {
            saveBtn.innerHTML = "ğŸ’¾ å„²å­˜ (Save)"; saveBtn.disabled = false; saveBtn.classList.remove('text-gray-400');
        }

        document.getElementById('review-title').innerText = currentArticleTitle;
        
        const contentDiv = document.getElementById('review-content');
        const words = currentArticleText.split(/(\s+)/); 
        contentDiv.innerHTML = words.map(w => {
            if(w.trim().length === 0) return w; 
            const rawWord = w.replace(/[^\w']/g, ""); 
            if(!rawWord) return w; 
            return `<span class="clickable-word" onclick="handleWordClick('${rawWord}', this)">${w}</span>`;
        }).join('');

        document.getElementById('review-content-chn').innerHTML = currentArticleChinese || "(æš«ç„¡ç¿»è­¯)";
    }

    function saveCurrentArticle() {
        if(!currentArticleText) return;
        const btn = document.getElementById('btn-save-article');
        btn.innerText = "Saving...";
        callApi('saveArticle', { 
            userId: getUserId(), 
            title: currentArticleTitle, 
            content: currentArticleText,
            contentChn: currentArticleChinese 
        }).then(() => {
            btn.innerText = "âœ“ å·²å„²å­˜"; btn.disabled = true; btn.classList.add('text-green-600');
        });
    }

    function openLibrary() {
        document.getElementById('view-input').classList.add('hidden');
        document.getElementById('view-library').classList.remove('hidden');
        document.getElementById('view-library').classList.add('flex');
        loadLibrary();
    }
    function loadLibrary() {
        callApi('getArticles', { userId: getUserId() }).then(res => {
             const list = document.getElementById('library-list');
             if(!res.data.length) list.innerHTML='<p class="text-center text-gray-400 mt-4">å°šç„¡æ”¶è—æ–‡ç« ã€‚</p>';
             else list.innerHTML = res.data.map(art => `
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 flex justify-between items-center group cursor-pointer hover:bg-white hover:shadow-md transition" onclick="readArchivedArticle('${art.title}', '${escape(art.content)}', '${escape(art.contentChn)}')">
                    <div>
                        <h3 class="font-bold text-indigo-700 font-eng text-lg">${art.title}</h3>
                        <p class="text-xs text-gray-400 mt-1">${new Date(art.date).toLocaleDateString()}</p>
                    </div>
                    <button onclick="event.stopPropagation(); delArticle('${art.id}', this)" class="text-gray-300 hover:text-red-500 p-2">ğŸ—‘ï¸</button>
                </div>`).join('');
        });
    }
    
    function readArchivedArticle(title, contentEscaped, contentChnEscaped) {
        const content = unescape(contentEscaped);
        const contentChn = contentChnEscaped && contentChnEscaped !== 'undefined' ? unescape(contentChnEscaped) : "";
        document.getElementById('view-library').classList.add('hidden');
        document.getElementById('view-library').classList.remove('flex');
        currentArticleTitle = title;
        currentArticleText = content;
        currentArticleChinese = contentChn;
        showReviewPage(true);
    }
    function delArticle(id, btn) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ–‡ç« ?")) callApi('delArticle', { userId: getUserId(), id }).then(()=>btn.closest('div').remove());
    }

    async function handleWordClick(word, el) {
        if(!isPlayingFull) speak(word);
        const popup = document.getElementById('word-popup');
        const rect = el.getBoundingClientRect();
        const parentRect = document.getElementById('view-review').getBoundingClientRect();
        
        let top = rect.top - parentRect.top - popup.offsetHeight - 10;
        if(top < 0) top = rect.bottom - parentRect.top + 10;
        popup.style.top = `${top}px`; popup.style.left = `${rect.left - parentRect.left}px`;
        popup.style.display = 'block';
        
        document.getElementById('popup-word').innerText = word;
        document.getElementById('popup-ipa').innerText = "...";
        document.getElementById('popup-def').innerText = "Translating...";
        
        let startIdx = Math.max(0, currentArticleText.indexOf(word) - 50);
        let endIdx = Math.min(currentArticleText.length, currentArticleText.indexOf(word) + word.length + 50);
        let contextSnippet = currentArticleText.substring(startIdx, endIdx).trim();
        const sentences = currentArticleText.match(/[^\.!\?]+[\.!\?]+/g) || [currentArticleText];
        const exactSentence = sentences.find(s => s.includes(word)) || contextSnippet;

        currentPopupData = { word: word, context: exactSentence.trim() }; 

        if (wordCache[word]) updatePopup(wordCache[word]);
        else {
            try {
                const res = await callApi('translate', { word: word, context: currentPopupData.context });
                if(res.status === 'success') { wordCache[word] = res.data; updatePopup(res.data); } 
                else { document.getElementById('popup-def').innerText = "Translation not found."; }
            } catch(e) { document.getElementById('popup-def').innerText = "Error loading."; }
        }
    }
    function updatePopup(data) {
        document.getElementById('popup-ipa').innerText = data.ipa || '';
        document.getElementById('popup-def').innerText = data.def;
        currentPopupData = { ...currentPopupData, ...data };
    }
    function closePopup() { document.getElementById('word-popup').style.display = 'none'; }
    function playPopupAudio() { if(currentPopupData) speak(currentPopupData.word); }
    
    function savePopupWord() {
        if(!currentPopupData || !currentPopupData.def) return;
        const btn = document.getElementById('btn-popup-save'); btn.innerText = "å„²å­˜ä¸­...";
        callApi('saveVocab', { 
            userId: getUserId(), 
            word: currentPopupData.word, 
            ipa: currentPopupData.ipa, 
            def: currentPopupData.def, 
            ctx: currentPopupData.context, 
            ctxChn: currentPopupData.example_chn || "(From Review)" 
        }).then(() => { btn.innerText = "âœ“ å·²å„²å­˜"; btn.classList.replace('bg-indigo-600','bg-green-500'); btn.disabled=true; });
    }

    // ğŸ”¥ å…¨æ–‡æœ—è®€ (æ¨¡æ“¬çœŸäººåˆ†æ®µ)
    function playFullArticle() {
        if(isPlayingFull){ stopFullAudio(); return; }
        isPlayingFull = true; 
        document.getElementById('btn-read-all').innerText='ğŸ›‘ åœæ­¢æœ—è®€ (Stop)'; 
        window.speechSynthesis.cancel();
        
        const fullText = currentArticleTitle + ". " + currentArticleText;
        const rawSentences = fullText.match(/[^.!?]+[.!?]+(\s|$)/g) || [fullText];
        
        utteranceQueue = rawSentences;
        playQueue(0);
    }

    function playQueue(index) {
        if (!isPlayingFull || index >= utteranceQueue.length) {
            stopFullAudio();
            return;
        }

        const txt = utteranceQueue[index].trim();
        if(!txt) { playQueue(index+1); return; }

        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-US';
        u.rate = parseFloat(document.getElementById('input-rate').value) || 1;
        u.pitch = parseFloat(document.getElementById('input-pitch').value) || 1;
        const v = voices[document.getElementById('input-voice').value]; if(v)u.voice=v;

        u.onend = function() {
            if(isPlayingFull) {
                setTimeout(() => { playQueue(index + 1); }, 300);
            }
        };
        
        window.speechSynthesis.speak(u);
    }

    function stopFullAudio(){ 
        window.speechSynthesis.cancel(); 
        isPlayingFull=false; 
        document.getElementById('btn-read-all').innerText='ğŸ”Š å…¨æ–‡æœ—è®€ (è‹±æ–‡)'; 
    }

    function openWordBank() { 
        document.getElementById('view-input').classList.add('hidden'); 
        document.getElementById('view-wordbank').classList.remove('hidden'); document.getElementById('view-wordbank').classList.add('flex'); loadWordBank(); 
    }
    
    function loadWordBank() { 
        callApi('getVocab', { userId: getUserId() }).then(res => {
             const list = document.getElementById('wordbank-list');
             if(!res.data.length) list.innerHTML='<p class="text-center text-gray-400 mt-4">å°šç„¡ç”Ÿå­— (No words yet).</p>';
             else list.innerHTML = res.data.map(w => {
                const safeContext = w.context.replace(/'/g, "&#39;");
                return `
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold text-indigo-700 cursor-pointer hover:text-indigo-900" onclick="speak('${w.word.replace(/'/g, "\\'")}')">ğŸ”Š ${w.word}</span>
                            <span class="text-sm font-mono text-gray-500 bg-white px-1 rounded border border-gray-200">${w.ipa}</span>
                        </div>
                        <button onclick="delWord('${w.id}',this)" class="text-gray-300 hover:text-red-500 p-1">ğŸ—‘ï¸</button>
                    </div>
                    <p class="text-gray-700 font-chn mb-3 font-bold border-b border-gray-200 pb-2">${w.def}</p>
                    <div class="bg-white p-3 rounded-lg border border-gray-100 text-sm">
                        <p class="text-gray-800 font-eng mb-1 cursor-pointer hover:text-indigo-600 transition" onclick="speak('${safeContext}')">ğŸ”Š ${w.context}</p>
                        <p class="text-gray-500 font-chn text-xs mt-1">${w.contextChn || "..."}</p>
                    </div>
                </div>`;
             }).join('');
        });
    }

    function saveWord(w,i,d,ctxEscaped,ctxChnEscaped,btn){ 
        btn.innerText="âœ“"; btn.disabled=true; 
        callApi('saveVocab',{userId:getUserId(),word:w,ipa:i,def:d,ctx:unescape(ctxEscaped),ctxChn:unescape(ctxChnEscaped)}); 
    }
    function delWord(id,btn){ if(confirm("ç¢ºå®šåˆªé™¤?")) callApi('delVocab',{userId:getUserId(),id}).then(()=>btn.closest('div.bg-gray-50').remove()); }

    document.addEventListener('click', function(e) {
        const popup = document.getElementById('word-popup');
        if (popup.style.display === 'block' && !popup.contains(e.target) && !e.target.classList.contains('clickable-word')) closePopup();
    });

    init();
  </script>
</body>
</html>
